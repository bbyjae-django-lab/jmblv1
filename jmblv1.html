<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>JUMBL</title>
    <style>
        :root {
            --bg: #F6F7FB;
            --fg: #0F1220;
            --muted: #6B7280;
            --track: #ECECEC;
            --tile-bg: #FFFFFF;
            --tile-fg: #111827;
            --btn-bg: #FFFFFF;
            --btn-fg: #0F1220;
            --accent: #3B82F6;
            --danger: #EF4444;
            --shadow: 0 6px 20px rgba(0,0,0,.08);
            --radius: 16px;
        }

        .dark {
            --bg: #0F1115;
            --fg: #E6E7EB;
            --muted: #9AA1AA;
            --track: #1F2430;
            --tile-bg: #171A20;
            --tile-fg: #F7F7FA;
            --btn-bg: #171A20;
            --btn-fg: #E6E7EB;
            --accent: #7CB2FF;
            --danger: #FF6B88;
            --shadow: 0 8px 24px rgba(0,0,0,.35);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: system-ui, -apple-system, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--fg);
            height: 100dvh;
            min-height: 100dvh;
            overflow: hidden;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }

        .app {
            width: min(100vw, 600px);
            height: 100dvh;
            min-height: 100dvh;
            margin: 0 auto;
            padding: calc(env(safe-area-inset-top) + 16px) 16px calc(env(safe-area-inset-bottom) + 18px) 16px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .header {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
        }

        .title {
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            grid-column: 2;
        }

        .theme-toggle {
            justify-self: end;
            background: var(--btn-bg);
            border: none;
            width: 48px;
            height: 48px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 80ms ease;
        }

        .theme-toggle:hover {
            transform: scale(0.98);
        }

        .theme-toggle:active {
            transform: scale(0.96);
            box-shadow: 0 2px 8px rgba(0,0,0,.1);
        }

        .theme-toggle svg {
            width: 20px;
            height: 20px;
            fill: var(--fg);
        }

        .lives {
            display: flex;
            justify-content: center;
            gap: 12px;
            align-items: center;
        }

        .life-pip {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--accent);
            transition: opacity 150ms ease;
        }

        .life-pip.lost {
            opacity: 0.3;
        }

        .level-label {
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: var(--muted);
        }

        .timer-card {
            background: var(--tile-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 16px;
        }

        .timer-track {
            width: 100%;
            height: 14px;
            background: var(--track);
            border-radius: 9999px;
            overflow: hidden;
            position: relative;
        }

        .timer-fill {
            height: 100%;
            background: var(--accent);
            width: 100%;
            transition: width 100ms linear;
            border-radius: 9999px;
        }

        .answer-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            justify-content: center;
        }

        .answer-tile {
            aspect-ratio: 1 / 1;
            min-height: 56px;
            background: var(--tile-bg);
            color: var(--tile-fg);
            border: none;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .letter-bank {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            justify-content: center;
        }

        .letter-btn {
            aspect-ratio: 1 / 1;
            min-height: 56px;
            background: var(--btn-bg);
            color: var(--btn-fg);
            border: none;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 80ms ease;
        }

        .letter-btn:not(:disabled):hover {
            transform: scale(0.98);
        }

        .letter-btn:not(:disabled):active {
            transform: scale(0.96);
            box-shadow: 0 2px 8px rgba(0,0,0,.15);
        }

        .letter-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 16px;
        }

        .control-btn {
            min-height: 56px;
            padding: 12px 24px;
            background: var(--btn-bg);
            color: var(--btn-fg);
            border: none;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 80ms ease;
        }

        .control-btn:hover {
            transform: scale(0.98);
        }

        .control-btn:active {
            transform: scale(0.96);
            box-shadow: 0 2px 8px rgba(0,0,0,.15);
        }

        .spacer {
            flex: 1;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg);
            color: var(--fg);
            border-radius: 24px;
            padding: 32px;
            max-width: 400px;
            width: 100%;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .modal-body {
            font-size: 16px;
            line-height: 1.5;
            color: var(--muted);
            margin-bottom: 24px;
        }

        .modal-body ul {
            text-align: left;
            margin: 16px 0;
            padding-left: 20px;
        }

        .modal-body li {
            margin: 8px 0;
        }

        .modal-btn {
            min-height: 56px;
            padding: 16px 32px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 80ms ease;
            width: 100%;
        }

        .modal-btn:hover {
            transform: scale(0.98);
        }

        .modal-btn:active {
            transform: scale(0.96);
        }

        .hidden {
            display: none;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Animations */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes celebrate {
            0% { transform: scale(1); }
            25% { transform: scale(1.05); }
            50% { transform: scale(1.1); }
            75% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-6px); }
            75% { transform: translateX(6px); }
        }

        @keyframes jiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-2deg); }
            75% { transform: rotate(2deg); }
        }

        @keyframes shudder {
            0%, 100% { transform: translateY(0); }
            20% { transform: translateY(-4px); }
            40% { transform: translateY(4px); }
            60% { transform: translateY(-3px); }
            80% { transform: translateY(2px); }
        }

        .pop {
            animation: pop 0.2s ease;
        }

        .celebrate {
            animation: celebrate 0.6s ease;
        }

        .shake {
            animation: shake 0.2s ease;
        }

        .jiggle {
            animation: jiggle 0.25s ease;
        }

        .shudder {
            animation: shudder 0.8s ease;
        }

        @media (prefers-reduced-motion: reduce) {
            .pop, .celebrate, .shake, .jiggle, .shudder {
                animation-duration: 0.01s;
            }
        }

        /* Focus styles */
        button:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div></div>
            <h1 class="title">JUMBL</h1>
            <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                <svg class="sun-icon" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
                <svg class="moon-icon hidden" viewBox="0 0 24 24">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
            </button>
        </header>

        <div class="lives" aria-label="Lives">
            <div class="life-pip" id="life1"></div>
            <div class="life-pip" id="life2"></div>
            <div class="life-pip" id="life3"></div>
            <div class="sr-only" id="livesText">Lives: 3 of 3</div>
        </div>

        <div class="level-label" id="levelLabel">Level 1</div>

        <div class="timer-card">
            <div class="timer-track" role="progressbar" aria-valuemin="0" aria-valuemax="25" aria-valuenow="25" id="timerBar">
                <div class="timer-fill" id="timerFill"></div>
            </div>
        </div>

        <div class="answer-row" id="answerRow" aria-label="Your guess">
            <div class="answer-tile" id="slot0"></div>
            <div class="answer-tile" id="slot1"></div>
            <div class="answer-tile" id="slot2"></div>
            <div class="answer-tile" id="slot3"></div>
            <div class="answer-tile" id="slot4"></div>
        </div>

        <div class="letter-bank" id="letterBank" aria-label="Letter bank">
            <button class="letter-btn" id="bank0"></button>
            <button class="letter-btn" id="bank1"></button>
            <button class="letter-btn" id="bank2"></button>
            <button class="letter-btn" id="bank3"></button>
            <button class="letter-btn" id="bank4"></button>
        </div>

        <div class="controls">
            <button class="control-btn" id="shuffleBtn">Shuffle</button>
            <button class="control-btn" id="clearAllBtn">Clear All</button>
        </div>

        <div class="spacer"></div>
    </div>

    <!-- Loading Modal -->
    <div class="modal" id="loadingModal">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="loadingTitle">
            <h2 class="modal-title" id="loadingTitle">Loading word lists…</h2>
            <div class="modal-body" id="loadingBody">
                Please wait while we load the word lists.
            </div>
            <button class="modal-btn hidden" id="retryBtn">Retry</button>
        </div>
    </div>

    <!-- Intro Modal -->
    <div class="modal hidden" id="introModal">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="introTitle">
            <h2 class="modal-title" id="introTitle">RULES</h2>
            <div class="modal-body">
                <ul>
                    <li>Use the jumbled letters to make a real 5-letter word.</li>
                    <li>Beat the clock to <strong>level up</strong> and refill the timer.</li>
                    <li>If you enter a real word that isn't the answer, you get <strong>+5 seconds</strong> (capped at 25s total).</li>
                    <li>If the timer hits zero, we <strong>reveal the word</strong> and you <strong>lose a life</strong>. If you still have lives left, you'll get a <strong>new word at the same level</strong> and the timer <strong>resets</strong>.</li>
                </ul>
                <p><strong>25 seconds per word • 3 lives</strong></p>
                <p><strong>Tip:</strong> ⤮ Shuffle • ⌫ Clear All</p>
            </div>
            <button class="modal-btn" id="playBtn">Play</button>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div class="modal hidden" id="gameOverModal">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="gameOverTitle">
            <h2 class="modal-title" id="gameOverTitle">Game Over</h2>
            <div class="modal-body" id="gameOverBody">
                You reached Level 1.
            </div>
            <button class="modal-btn" id="tryAgainBtn">Try again</button>
        </div>
    </div>

    <!-- Live region for timer announcements -->
    <div class="sr-only" aria-live="polite" id="timerAnnouncements"></div>

    <script>
        // Game state
        let answerWord = '';
        let bank = [];
        let current = ['', '', '', '', ''];
        let placedIndex = [null, null, null, null, null];
        let lives = 3;
        let level = 1;
        let runStartAt = 0;
        let deadlineAt = 0;
        let timerHandle = null;
        let isAnimating = false;
        let inputsDisabled = false;

        // Word lists
        let ANSWER_POOL = [];
        let GUESSES_SET = new Set();

        // Constants
        const COUNTDOWN_SECONDS = 25;
        const STARTING_LIVES = 3;
        const TIME_BOOST_SECONDS = 5;
        const MAX_TIME_SECONDS = 25;
        const TICK_MS = 100;

        // DOM elements
        const themeToggle = document.getElementById('themeToggle');
        const sunIcon = document.querySelector('.sun-icon');
        const moonIcon = document.querySelector('.moon-icon');
        const livesText = document.getElementById('livesText');
        const levelLabel = document.getElementById('levelLabel');
        const timerBar = document.getElementById('timerBar');
        const timerFill = document.getElementById('timerFill');
        const answerRow = document.getElementById('answerRow');
        const letterBank = document.getElementById('letterBank');
        const shuffleBtn = document.getElementById('shuffleBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const loadingModal = document.getElementById('loadingModal');
        const loadingBody = document.getElementById('loadingBody');
        const retryBtn = document.getElementById('retryBtn');
        const introModal = document.getElementById('introModal');
        const playBtn = document.getElementById('playBtn');
        const gameOverModal = document.getElementById('gameOverModal');
        const gameOverBody = document.getElementById('gameOverBody');
        const tryAgainBtn = document.getElementById('tryAgainBtn');
        const timerAnnouncements = document.getElementById('timerAnnouncements');

        // Theme management
        function initializeTheme() {
            const stored = localStorage.getItem('jumbl-theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const isDark = stored ? stored === 'dark' : prefersDark;
            
            if (isDark) {
                document.documentElement.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('jumbl-theme', isDark ? 'dark' : 'light');
            
            if (isDark) {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            }
        }

        // Word list loading
        async function loadWordLists() {
            try {
                const [answersResponse, guessesResponse] = await Promise.all([
                    fetch('answers.txt', { cache: 'no-store' }),
                    fetch('guesses.txt', { cache: 'no-store' })
                ]);

                if (!answersResponse.ok || !guessesResponse.ok) {
                    throw new Error('Failed to fetch word lists');
                }

                const answersText = await answersResponse.text();
                const guessesText = await guessesResponse.text();

                ANSWER_POOL = answersText
                    .split('\n')
                    .map(word => word.trim().toUpperCase())
                    .filter(word => /^[A-Z]{5}$/.test(word));

                const guessesList = guessesText
                    .split('\n')
                    .map(word => word.trim().toUpperCase())
                    .filter(word => /^[A-Z]{5}$/.test(word));

                GUESSES_SET = new Set(guessesList);

                if (ANSWER_POOL.length === 0 || GUESSES_SET.size === 0) {
                    throw new Error('Word lists are empty');
                }

                loadingModal.classList.add('hidden');
                introModal.classList.remove('hidden');
                playBtn.focus();
            } catch (error) {
                console.error('Failed to load word lists:', error);
                loadingBody.textContent = 'Failed to load word lists. Please check your connection and try again.';
                retryBtn.classList.remove('hidden');
                retryBtn.focus();
            }
        }

        // Game initialization
        function startRun() {
            lives = STARTING_LIVES;
            level = 1;
            runStartAt = performance.now();
            nextWord(false);
        }

        function buildBankFrom(word) {
            const letters = word.split('').map(ch => ({ ch, used: false }));
            // Fisher-Yates shuffle
            for (let i = letters.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [letters[i], letters[j]] = [letters[j], letters[i]];
            }
            return letters;
        }

        function nextWord(increment) {
            if (increment) level++;
            
            answerWord = ANSWER_POOL[Math.floor(Math.random() * ANSWER_POOL.length)];
            bank = buildBankFrom(answerWord);
            current = ['', '', '', '', ''];
            placedIndex = [null, null, null, null, null];
            inputsDisabled = false;
            
            stopTimer();
            renderUI();
            startTimer();
        }

        // Timer management
        function startTimer() {
            deadlineAt = performance.now() + COUNTDOWN_SECONDS * 1000;
            timerHandle = setInterval(tick, TICK_MS);
            tick(); // Immediate update
        }

        function stopTimer() {
            if (timerHandle) {
                clearInterval(timerHandle);
                timerHandle = null;
            }
        }

        function tick() {
            const now = performance.now();
            const remaining = Math.max(0, deadlineAt - now);
            const seconds = Math.ceil(remaining / 1000);
            const percentage = (remaining / (COUNTDOWN_SECONDS * 1000)) * 100;

            timerFill.style.width = `${percentage}%`;
            timerBar.setAttribute('aria-valuenow', seconds.toString());

            // Announce time remaining (≤1Hz)
            const shouldAnnounce = seconds <= 10 && seconds > 0 && remaining % 1000 < TICK_MS;
            if (shouldAnnounce) {
                timerAnnouncements.textContent = `${seconds} seconds remaining`;
            }

            if (remaining <= 0) {
                onTimeout();
            }
        }

        function addTime(seconds) {
            deadlineAt += seconds * 1000;
            const maxTime = performance.now() + MAX_TIME_SECONDS * 1000;
            deadlineAt = Math.min(deadlineAt, maxTime);
            tick(); // Immediate update
        }

        function onTimeout() {
            stopTimer();
            lives--;
            revealAndShudder(answerWord);
            
            setTimeout(() => {
                if (lives > 0) {
                    nextWord(false);
                } else {
                    gameOver();
                }
            }, 1000);
        }

        // Game actions
        function onLetterTap(bankIndex) {
            if (inputsDisabled || isAnimating || bank[bankIndex].used) return;

            const nextSlot = current.findIndex(slot => slot === '');
            if (nextSlot === -1) return;

            current[nextSlot] = bank[bankIndex].ch;
            placedIndex[nextSlot] = bankIndex;
            bank[bankIndex].used = true;

            renderUI();
            
            // Play pop animation
            const slot = document.getElementById(`slot${nextSlot}`);
            slot.classList.add('pop');
            setTimeout(() => slot.classList.remove('pop'), 200);

            autoSubmitIfFull();
        }

        function onShuffle() {
            if (inputsDisabled || isAnimating) return;

            // Shuffle only unused bank letters
            const unusedIndices = [];
            const unusedLetters = [];
            
            bank.forEach((letter, index) => {
                if (!letter.used) {
                    unusedIndices.push(index);
                    unusedLetters.push(letter);
                }
            });

            // Fisher-Yates shuffle
            for (let i = unusedLetters.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [unusedLetters[i], unusedLetters[j]] = [unusedLetters[j], unusedLetters[i]];
            }

            // Apply shuffled letters back to bank
            unusedIndices.forEach((index, i) => {
                bank[index] = unusedLetters[i];
            });

            renderUI();
            
            // Play jiggle animation on unused buttons
            unusedIndices.forEach(index => {
                const btn = document.getElementById(`bank${index}`);
                btn.classList.add('jiggle');
                setTimeout(() => btn.classList.remove('jiggle'), 250);
            });
        }

        function onClearAll() {
            if (inputsDisabled || isAnimating) return;

            current.forEach((letter, slot) => {
                if (letter && placedIndex[slot] !== null) {
                    bank[placedIndex[slot]].used = false;
                }
            });

            current = ['', '', '', '', ''];
            placedIndex = [null, null, null, null, null];
            renderUI();
        }

        function autoSubmitIfFull() {
            if (current.every(slot => slot !== '')) {
                const guess = current.join('');
                setTimeout(() => evaluateGuess(guess), 100);
            }
        }

        function evaluateGuess(guess) {
            if (isAnimating || inputsDisabled) return;
            isAnimating = true;

            if (guess === answerWord) {
                // Correct - celebrate and advance
                stopTimer();
                
                // Play celebration animation
                current.forEach((_, i) => {
                    const slot = document.getElementById(`slot${i}`);
                    setTimeout(() => {
                        slot.classList.add('celebrate');
                        setTimeout(() => slot.classList.remove('celebrate'), 600);
                    }, i * 100);
                });

                setTimeout(() => {
                    isAnimating = false;
                    nextWord(true);
                }, 700);

            } else if (GUESSES_SET.has(guess)) {
                // Valid but wrong - add time and clear
                addTime(TIME_BOOST_SECONDS);
                onClearAll();
                isAnimating = false;

            } else {
                // Invalid - shake and clear
                answerRow.classList.add('shake');
                setTimeout(() => {
                    answerRow.classList.remove('shake');
                    onClearAll();
                    isAnimating = false;
                }, 200);
            }
        }

        function revealAndShudder(word) {
            inputsDisabled = true;
            current = word.split('');
            renderUI();

            answerRow.classList.add('shudder');
            setTimeout(() => {
                answerRow.classList.remove('shudder');
                inputsDisabled = false;
            }, 800);

            // Announce the revealed word
            timerAnnouncements.textContent = `The word was ${word}`;
        }

        function gameOver() {
            const completedLevels = level - 1;
            const runTime = Math.floor((performance.now() - runStartAt) / 1000);
            const minutes = Math.floor(runTime / 60);
            const seconds = runTime % 60;
            const timeText = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            gameOverBody.textContent = runTime > 0 
                ? `You reached Level ${completedLevels}. Run time: ${timeText}.`
                : `You reached Level ${completedLevels}.`;

            gameOverModal.classList.remove('hidden');
            tryAgainBtn.focus();
        }

        // UI rendering
        function renderUI() {
            // Lives
            for (let i = 1; i <= 3; i++) {
                const pip = document.getElementById(`life${i}`);
                pip.classList.toggle('lost', i > lives);
            }
            livesText.textContent = `Lives: ${lives} of 3`;

            // Level
            levelLabel.textContent = `Level ${level}`;

            // Answer tiles
            current.forEach((letter, i) => {
                document.getElementById(`slot${i}`).textContent = letter;
            });

            // Letter bank
            bank.forEach((letter, i) => {
                const btn = document.getElementById(`bank${i}`);
                btn.textContent = letter.ch;
                btn.disabled = letter.used || inputsDisabled;
            });

            // Controls
            shuffleBtn.disabled = inputsDisabled;
            clearAllBtn.disabled = inputsDisabled;
        }

        // Keyboard support
        function handleKeydown(event) {
            if (inputsDisabled || isAnimating) return;
            if (loadingModal.classList.contains('hidden') === false ||
                introModal.classList.contains('hidden') === false ||
                gameOverModal.classList.contains('hidden') === false) return;

            const key = event.key.toUpperCase();
            
            if (/^[A-Z]$/.test(key)) {
                // Find first unused bank entry with this letter
                const bankIndex = bank.findIndex(letter => 
                    letter.ch === key && !letter.used
                );
                if (bankIndex !== -1) {
                    onLetterTap(bankIndex);
                }
                event.preventDefault();
            } else if (key === ' ') {
                onShuffle();
                event.preventDefault();
            } else if (key === 'BACKSPACE' || key === 'DELETE') {
                onClearAll();
                event.preventDefault();
            }
        }

        // Event listeners
        themeToggle.addEventListener('click', toggleTheme);
        retryBtn.addEventListener('click', () => {
            retryBtn.classList.add('hidden');
            loadingBody.textContent = 'Please wait while we load the word lists.';
            loadWordLists();
        });
        playBtn.addEventListener('click', () => {
            introModal.classList.add('hidden');
            startRun();
        });
        tryAgainBtn.addEventListener('click', () => {
            gameOverModal.classList.add('hidden');
            startRun();
        });

        // Letter bank event listeners
        for (let i = 0; i < 5; i++) {
            document.getElementById(`bank${i}`).addEventListener('click', () => onLetterTap(i));
        }

        shuffleBtn.addEventListener('click', onShuffle);
        clearAllBtn.addEventListener('click', onClearAll);
        document.addEventListener('keydown', handleKeydown);

        // Initialize
        initializeTheme();
        loadWordLists();
    </script>
</body>
</html>
