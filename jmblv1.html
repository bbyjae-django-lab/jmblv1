<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>JUMBL</title>
  <script>
    // --- Theme boot (runs before paint) ---
    (function(){
      try {
        const key = 'jumbl-theme';
        const stored = localStorage.getItem(key);
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const wantDark = stored ? stored === 'dark' : prefersDark;
        document.documentElement.classList.toggle('dark', wantDark);
      } catch (e) {}
    })();
  </script>
  <style>
    :root{
      color-scheme: light dark;
      --bg:#F6F7FB; --fg:#0F1220; --muted:#6B7280; --track:#ECECEC;
      --tile-bg:#FFFFFF; --tile-fg:#111827; --btn-bg:#FFFFFF; --btn-fg:#0F1220;
      --accent:#3B82F6; --danger:#EF4444; --shadow:0 6px 20px rgba(0,0,0,.08); --radius:16px;
      --gap:10px; --tile-min:56px; --timer-h:14px; --card-radius:16px;
      --press-scale:.96; --press-ms:110ms;
      --anim-fast:200ms; --anim-med:500ms; --anim-shake:220ms; --anim-jiggle:260ms; --anim-shudder:800ms;
    }
    html.dark{
      --bg:#0F1115; --fg:#E6E7EB; --muted:#9AA1AA; --track:#1F2430;
      --tile-bg:#171A20; --tile-fg:#F7F7FA; --btn-bg:#171A20; --btn-fg:#E6E7EB;
      --accent:#7CB2FF; --danger:#FF6B88; --shadow:0 8px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      height:100dvh; min-height:100dvh; overflow:hidden; overscroll-behavior:none;
      -webkit-text-size-adjust:100%; -webkit-tap-highlight-color:transparent;
      font: 16px/1.2 system-ui,-apple-system,"SF Pro Text",Segoe UI,Roboto,Arial,sans-serif;
    }
    .app{ width:min(100vw,600px); margin:0 auto; height:100%;
      padding-top:calc(env(safe-area-inset-top) + 16px);
      padding-bottom:calc(env(safe-area-inset-bottom) + 18px);
      display:grid; grid-template-rows:auto auto auto auto auto auto auto 1fr;
      gap:14px; align-items:start; }

    /* Header */
    .header{ display:grid; grid-template-columns:1fr auto 1fr; align-items:center; padding:0 16px; }
    .title{ text-align:center; font-weight:700; letter-spacing:0.12em; }
    .theme-wrap{ display:flex; justify-content:flex-end; }
    .icon-btn{ appearance:none; border:0; background:var(--btn-bg); color:var(--btn-fg);
      width:40px; height:40px; border-radius:12px; box-shadow:var(--shadow);
      display:grid; place-items:center; cursor:pointer; transition:transform var(--press-ms) ease, box-shadow var(--press-ms) ease; }
    .icon-btn:active{ transform:scale(var(--press-scale)); }
    .icon{ width:22px; height:22px; display:block; }
    .icon.sun{ display: inline-block; }
    .icon.moon{ display: none; }
    html.dark .icon.sun{ display: none; }
    html.dark .icon.moon{ display: inline-block; }

    /* Lives */
    .lives{ display:flex; justify-content:center; gap:10px; }
    .pip{ width:12px; height:12px; border-radius:999px; background:var(--fg); opacity:.28; box-shadow:var(--shadow); }
    .pip.on{ opacity:1; }

    /* Level */
    .level{ text-align:center; color:var(--muted); font-weight:600; }

    /* Timer */
    .timer-card{ padding:12px 16px; }
    .timer{ position:relative; width:100%; height:var(--timer-h); background:var(--track); border-radius:9999px; overflow:hidden; }
    .timer .fill{ position:absolute; left:0; top:0; bottom:0; width:100%; background:var(--fg); border-radius:9999px; transition: width 100ms linear; transform:translateZ(0); }

    /* Rows */
    .row{ padding:0 16px; }
    .grid5{ display:grid; grid-template-columns:repeat(5, 1fr); gap:var(--gap); }
    .tile, .bank-btn{ aspect-ratio:1/1; min-width:var(--tile-min); min-height:var(--tile-min);
      border-radius:14px; background:var(--tile-bg); color:var(--tile-fg);
      display:grid; place-items:center; font-weight:800; font-size:clamp(20px, 5.8vw, 28px);
      box-shadow:var(--shadow); user-select:none; }
    .tile{ pointer-events:none; }
    .bank-btn{ cursor:pointer; border:0; transition: transform var(--press-ms) ease, box-shadow var(--press-ms) ease; }
    .bank-btn:disabled{ opacity:.38; cursor:default; }
    .bank-btn:active{ transform:scale(var(--press-scale)); }

    /* Controls */
    .controls{ display:flex; justify-content:center; gap:14px; padding:0 16px; }
    .btn{ appearance:none; border:0; padding:12px 16px; border-radius:14px; background:var(--btn-bg); color:var(--btn-fg); box-shadow:var(--shadow);
      font-weight:700; cursor:pointer; transition: transform var(--press-ms) ease, box-shadow var(--press-ms) ease; }
    .btn:active{ transform:scale(var(--press-scale)); }

    /* Animations */
    @keyframes pop { 0%{transform:scale(.94)} 100%{transform:scale(1)} }
    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)} }
    @keyframes jiggle { 0%,100%{transform:translateX(0) rotate(0)} 25%{transform:rotate(-2deg)} 75%{transform:rotate(2deg)} }
    @keyframes shudder { 0%,100%{transform:translateX(0)} 10%{transform:translateX(-2px)} 20%{transform:translateX(2px)} 30%{transform:translateX(-2px)} 40%{transform:translateX(2px)} 50%{transform:translateX(-1px)} 60%{transform:translateX(1px)} 70%{transform:translateX(-1px)} 80%{transform:translateX(1px)} 90%{transform:translateX(-.5px)} }
    .pop{ animation: pop var(--anim-fast) ease; }
    .shake{ animation: shake var(--anim-shake) ease; }
    .jiggle{ animation: jiggle var(--anim-jiggle) ease; }
    .shudder{ animation: shudder var(--anim-shudder) ease; }

    @media (prefers-reduced-motion: reduce){
      .pop,.shake,.jiggle,.shudder{ animation-duration: 1ms !important; }
      .btn,.bank-btn{ transition:none; }
      .timer .fill{ transition:none; }
    }

    /* Modals */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:50; }
    .modal-backdrop.open{ display:block; }
    .modal{ position:fixed; inset:0; display:grid; place-items:center; z-index:60; pointer-events:none; }
    .modal > .card{ width:min(92vw, 520px); background:var(--tile-bg); color:var(--tile-fg); border-radius:24px; box-shadow:var(--shadow); padding:22px; pointer-events:auto; }
    .modal h2{ margin:0 0 10px; letter-spacing:.06em; }
    .modal p{ margin:8px 0; color:var(--muted); }
    .modal .actions{ margin-top:14px; display:flex; gap:10px; justify-content:flex-end; }

    /* A11y */
    .sr-only{ position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }
  </style>
</head>
<body>
  <div class="app" id="app" aria-live="off">
    <!-- Header -->
    <header class="header" aria-label="Header">
      <div></div>
      <div class="title" aria-label="Game title">JUMBL</div>
      <div class="theme-wrap">
        <button class="icon-btn" id="themeToggle" aria-label="Toggle theme" title="Toggle theme">
          <!-- Sun: symmetrical circle with 8 rays -->
          <svg class="icon sun" viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="12" cy="12" r="4.5" fill="currentColor"></circle>
            <g fill="currentColor">
              <rect x="11.25" y="1.5" width="1.5" height="4"></rect>
              <rect x="11.25" y="18.5" width="1.5" height="4"></rect>
              <rect x="1.5" y="11.25" width="4" height="1.5"></rect>
              <rect x="18.5" y="11.25" width="4" height="1.5"></rect>
              <rect x="3.636" y="3.636" width="1.5" height="4" transform="rotate(-45 4.386 5.636)"></rect>
              <rect x="18.864" y="16.364" width="1.5" height="4" transform="rotate(-45 19.614 18.364)"></rect>
              <rect x="3.636" y="16.364" width="1.5" height="4" transform="rotate(45 4.386 18.364)"></rect>
              <rect x="18.864" y="3.636" width="1.5" height="4" transform="rotate(45 19.614 5.636)"></rect>
            </g>
          </svg>
          <!-- Moon: simple crescent -->
          <svg class="icon moon" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M21 13.5A9 9 0 0 1 10.5 3c.4 0 .8.03 1.17.09A7.5 7.5 0 1 0 21 13.5Z"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- Lives -->
    <div class="lives" aria-label="Lives">
      <span id="pip1" class="pip on"></span>
      <span id="pip2" class="pip on"></span>
      <span id="pip3" class="pip on"></span>
      <span class="sr-only" id="livesText">Lives: 3 of 3</span>
    </div>

    <!-- Level -->
    <div class="level" id="levelLabel" aria-label="Level">Level 1</div>

    <!-- Timer -->
    <div class="timer-card row">
      <div class="timer" role="progressbar" aria-valuemin="0" aria-valuemax="25" aria-valuenow="25" aria-label="Time remaining">
        <div class="fill" id="timerFill"></div>
      </div>
    </div>

    <!-- Answer row (top) -->
    <div class="row" aria-label="Your guess">
      <div class="grid5" id="answerRow">
        <div class="tile" data-slot="0"></div>
        <div class="tile" data-slot="1"></div>
        <div class="tile" data-slot="2"></div>
        <div class="tile" data-slot="3"></div>
        <div class="tile" data-slot="4"></div>
      </div>
    </div>

    <!-- Letter bank (below answer row) -->
    <div class="row" aria-label="Letter bank">
      <div class="grid5" id="bankRow">
        <!-- buttons injected -->
      </div>
    </div>

    <!-- Controls -->
    <div class="controls" aria-label="Controls">
      <button class="btn" id="shuffleBtn" type="button" aria-label="Shuffle letters">⤮ Shuffle</button>
      <button class="btn" id="clearBtn" type="button" aria-label="Clear all">⌫ Clear All</button>
    </div>

    <div></div><!-- spacer -->
  </div>

  <!-- Modals -->
  <div id="backdrop" class="modal-backdrop"></div>

  <div id="loadingModal" class="modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="loadingTitle">
      <h2 id="loadingTitle">Loading word lists…</h2>
      <p id="loadingBody">Fetching…</p>
      <div class="actions">
        <button id="retryBtn" class="btn" type="button" disabled>Retry</button>
      </div>
    </div>
  </div>

  <div id="introModal" class="modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="rulesTitle">
      <h2 id="rulesTitle">RULES</h2>
      <p>Use the jumbled letters to make a real 5-letter word.</p>
      <p>Beat the clock to <strong>level up</strong> and refill the timer.</p>
      <p>If you enter a real word that isn’t the answer, you get <strong>+5 seconds</strong> (capped at 25s total).</p>
      <p>If the timer hits zero, we <strong>reveal the word</strong> and you <strong>lose a life</strong>. If you still have lives left, you’ll get a <strong>new word at the same level</strong> and the timer <strong>resets</strong>.</p>
      <p><strong>25 seconds per word • 3 lives</strong></p>
      <p><strong>Tip:</strong> ⤮ Shuffle • ⌫ Clear All</p>
      <div class="actions"><button id="playBtn" class="btn" type="button">Play</button></div>
    </div>
  </div>

  <div id="gameOverModal" class="modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="overTitle">
      <h2 id="overTitle">Game Over</h2>
      <p id="overBody">You reached Level 0.</p>
      <div class="actions"><button id="againBtn" class="btn" type="button">Try again</button></div>
    </div>
  </div>

  <div id="ariaTimer" class="sr-only" aria-live="polite"></div>

  <script>
  (function(){
    'use strict';

    // ===== Constants =====
    const COUNTDOWN_SECONDS = 25;
    const STARTING_LIVES = 3;
    const TIME_BOOST_SECONDS = 5;
    const MAX_TIME_SECONDS = 25; // cap
    const TICK_MS = 100;

    // ===== State =====
    let ANSWER_POOL = [];
    let GUESSES_SET = new Set();

    const state = {
      answerWord: '',
      bank: [],          // [{ch, used}]
      current: ['', '', '', '', ''],
      placedIndex: [null, null, null, null, null],
      lives: STARTING_LIVES,
      level: 1,
      runStartAt: 0,
      deadlineAt: 0,
      timerHandle: null,
      isAnimating: false,
      lastAnnounceSec: null,
      modalOpen: false,
    };

    // ===== DOM =====
    const q = sel => document.querySelector(sel);
    const qa = sel => Array.from(document.querySelectorAll(sel));
    const el = {
      timerFill: q('#timerFill'),
      timerBar: q('.timer'),
      ariaTimer: q('#ariaTimer'),
      levelLabel: q('#levelLabel'),
      livesText: q('#livesText'),
      pips: [q('#pip1'), q('#pip2'), q('#pip3')],
      answerRow: q('#answerRow'),
      bankRow: q('#bankRow'),
      shuffleBtn: q('#shuffleBtn'),
      clearBtn: q('#clearBtn'),
      themeToggle: q('#themeToggle'),
      backdrop: q('#backdrop'),
      loadingModal: q('#loadingModal'),
      retryBtn: q('#retryBtn'),
      loadingBody: q('#loadingBody'),
      introModal: q('#introModal'),
      playBtn: q('#playBtn'),
      overModal: q('#gameOverModal'),
      overBody: q('#overBody'),
      againBtn: q('#againBtn'),
    };

    // ===== Utilities =====
    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
    const randInt = n => Math.floor(Math.random()*n);
    const shuffle = arr => { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; };
    const upper5 = s => (s||'').toUpperCase().trim();
    const now = () => performance.now();

    function setTheme(next){
      const root = document.documentElement;
      const dark = next === 'dark' ? true : next === 'light' ? false : !root.classList.contains('dark');
      root.classList.toggle('dark', dark);
      try{ localStorage.setItem('jumbl-theme', dark ? 'dark' : 'light'); }catch(e){}
    }

    // ===== Rendering =====
    function renderLives(){
      for (let i=0;i<STARTING_LIVES;i++){
        el.pips[i].classList.toggle('on', i < state.lives);
      }
      el.livesText.textContent = `Lives: ${state.lives} of ${STARTING_LIVES}`;
    }

    function renderLevel(){
      el.levelLabel.textContent = `Level ${state.level}`; // exact copy
    }

    function renderTimer(){
      const remainMs = Math.max(0, state.deadlineAt - now());
      const pct = clamp(remainMs / (COUNTDOWN_SECONDS*1000), 0, 1);
      el.timerFill.style.width = (pct*100).toFixed(3) + '%'; // left-anchored; drains right->left
      const secs = Math.ceil(remainMs/1000);
      if (secs !== state.lastAnnounceSec){
        // aria progressbar value
        q('.timer').setAttribute('aria-valuenow', String(secs));
        // announce at <=1Hz
        el.ariaTimer.textContent = `${secs} seconds remaining`;
        state.lastAnnounceSec = secs;
      }
    }

    function renderAnswer(){
      qa('#answerRow .tile').forEach((t,i)=>{
        t.textContent = state.current[i] || '';
      });
    }

    function renderBank(){
      // build 5 buttons
      el.bankRow.innerHTML = '';
      state.bank.forEach((b, i)=>{
        const btn = document.createElement('button');
        btn.type = 'button'; btn.className = 'bank-btn';
        btn.textContent = b.ch; btn.disabled = !!b.used;
        btn.setAttribute('data-index', String(i));
        btn.addEventListener('click', ()=>onLetterTap(i));
        el.bankRow.appendChild(btn);
      });
    }

    function renderUI(){
      renderLives();
      renderLevel();
      renderTimer();
      renderAnswer();
      renderBank();
    }

    // ===== Word lists =====
    async function loadWordLists(){
      openModal(el.loadingModal, true);
      setLoadingStatus('Fetching…', true);
      try{
        const [aRes, gRes] = await Promise.all([
          fetch('answers.txt', {cache:'no-store'}),
          fetch('guesses.txt', {cache:'no-store'})
        ]);
        if(!aRes.ok || !gRes.ok) throw new Error('HTTP error');
        const [aText, gText] = await Promise.all([aRes.text(), gRes.text()]);
        const ans = aText.split(/\r?\n/).map(upper5).filter(x=>/^[A-Z]{5}$/.test(x));
        const gue = gText.split(/\r?\n/).map(upper5).filter(x=>/^[A-Z]{5}$/.test(x));
        if(!ans.length || !gue.length) throw new Error('Empty lists');
        ANSWER_POOL = ans;
        GUESSES_SET = new Set(gue);
        setLoadingStatus(`Loaded ${ans.length} answers, ${gue.length} guesses.`, false);
        // small delay for readability
        setTimeout(()=>{
          openModal(el.loadingModal, false);
          openModal(el.introModal, true);
          el.playBtn.focus();
        }, 300);
      } catch (e){
        console.error(e);
        setLoadingStatus('Error loading files. Serve over HTTP and ensure both files are beside index.html.', false);
        el.retryBtn.disabled = false;
      }
    }

    function setLoadingStatus(text, loading){
      el.loadingBody.textContent = text;
      el.retryBtn.disabled = !!loading;
    }

    // ===== Game flow =====
    function startRun(){
      state.lives = STARTING_LIVES;
      state.level = 1;
      state.runStartAt = performance.now();
      state.lastAnnounceSec = null;
      nextWord(false);
    }

    function buildBankFrom(word){
      const letters = word.split('');
      shuffle(letters);
      return letters.slice(0,5).map(ch=>({ch, used:false}));
    }

    function nextWord(increment){
      stopTimer();
      if (increment) state.level++;
      state.answerWord = ANSWER_POOL[randInt(ANSWER_POOL.length)];
      state.bank = buildBankFrom(state.answerWord);
      clearAll(); // resets current + placedIndex
      renderUI();
      startTimer();
    }

    function startTimer(){
      state.deadlineAt = now() + COUNTDOWN_SECONDS*1000;
      state.lastAnnounceSec = null;
      renderTimer();
      stopTimer();
      state.timerHandle = setInterval(()=>{
        renderTimer();
        if (now() >= state.deadlineAt){
          stopTimer();
          onTimeout();
        }
      }, TICK_MS);
    }

    function stopTimer(){ if (state.timerHandle){ clearInterval(state.timerHandle); state.timerHandle = null; } }

    function addTime(seconds){
      const remain = Math.max(0, state.deadlineAt - now());
      const newRemain = clamp(remain + seconds*1000, 0, MAX_TIME_SECONDS*1000);
      state.deadlineAt = now() + newRemain;
      renderTimer();
    }

    function onTimeout(){
      // lose a life
      state.lives = Math.max(0, state.lives - 1);
      renderLives();
      // reveal and shudder
      revealAndShudder(state.answerWord, () => {
        if (state.lives > 0){
          nextWord(false); // same level, new word
        } else {
          gameOver();
        }
      });
    }

    function revealAndShudder(word, done){
      state.modalOpen = true;
      disableInputs(true);
      state.current = word.split('');
      state.placedIndex = [null,null,null,null,null];
      renderAnswer();
      // play shudder on answer row
      const row = el.answerRow;
      row.classList.remove('shudder');
      void row.offsetWidth; // reflow
      row.classList.add('shudder');
      setTimeout(()=>{ row.classList.remove('shudder'); state.modalOpen = false; disableInputs(false); done && done(); }, prefersReduced() ? 10 : 800);
    }

    function prefersReduced(){ return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches; }

    function gameOver(){
      stopTimer();
      const levelsCompleted = state.level - 1;
      let runMs = Math.max(0, now() - state.runStartAt);
      const mm = String(Math.floor(runMs/60000)).padStart(2,'0');
      const ss = String(Math.floor((runMs%60000)/1000)).padStart(2,'0');
      el.overBody.textContent = `You reached Level ${levelsCompleted}.${levelsCompleted>=0?` Run time ${mm}:${ss}.`:''}`;
      openModal(el.overModal, true);
      el.againBtn.focus();
    }

    function clearAll(){
      for(let i=0;i<5;i++){
        const bi = state.placedIndex[i];
        if (bi!=null) state.bank[bi].used = false;
        state.current[i] = '';
        state.placedIndex[i] = null;
      }
      renderAnswer();
      renderBank();
    }

    function onLetterTap(bankIndex){
      if (state.modalOpen) return;
      const b = state.bank[bankIndex];
      if (!b || b.used) return;
      const slot = state.current.indexOf('');
      if (slot === -1) return;
      state.current[slot] = b.ch;
      state.placedIndex[slot] = bankIndex;
      b.used = true;
      // slot pop
      const tile = el.answerRow.querySelector(`[data-slot="${slot}"]`);
      if (tile){ tile.classList.remove('pop'); void tile.offsetWidth; tile.classList.add('pop'); }
      renderBank();
      autoSubmitIfFull();
    }

    function onShuffle(){
      // jiggle bank row
      const row = el.bankRow;
      row.classList.remove('jiggle'); void row.offsetWidth; row.classList.add('jiggle');
      // shuffle only unused entries among their positions
      const unusedIdx = state.bank.map((b,i)=>b.used?null:i).filter(i=>i!=null);
      const unused = unusedIdx.map(i=>state.bank[i]);
      const shuffled = shuffle(unused.slice());
      unusedIdx.forEach((idx,k)=>{ state.bank[idx] = shuffled[k]; });
      renderBank();
    }

    function autoSubmitIfFull(){
      if (state.current.every(ch => ch)){
        evaluateGuess(state.current.join(''));
      }
    }

    function evaluateGuess(guess){
      if (guess === state.answerWord){
        // correct
        stopTimer();
        // celebration (pop tiles)
        qa('#answerRow .tile').forEach((t)=>{ t.classList.remove('pop'); void t.offsetWidth; t.classList.add('pop'); });
        setTimeout(()=>{ nextWord(true); }, prefersReduced()? 10 : 520);
        return;
      }
      if (GUESSES_SET.has(guess)){
        // valid but wrong: +5s and clear row (no life lost)
        addTime(TIME_BOOST_SECONDS);
        clearAll();
      } else {
        // invalid: shake + clear (no life lost)
        const row = el.answerRow;
        row.classList.remove('shake'); void row.offsetWidth; row.classList.add('shake');
        setTimeout(()=>{ row.classList.remove('shake'); clearAll(); }, prefersReduced()? 10 : 220);
      }
    }

    function disableInputs(disabled){
      el.shuffleBtn.disabled = disabled;
      el.clearBtn.disabled = disabled;
      qa('#bankRow .bank-btn').forEach(b=> b.disabled = true);
    }

    // ===== Modals =====
    function openModal(modal, open){
      if (open){
        el.backdrop.classList.add('open');
        modal.setAttribute('aria-hidden','false');
        modal.style.display = 'grid';
        state.modalOpen = true;
      } else {
        modal.setAttribute('aria-hidden','true');
        modal.style.display = 'none';
        // check others
        const anyOpen = [el.loadingModal, el.introModal, el.overModal].some(m=>m.getAttribute('aria-hidden')==='false');
        if (!anyOpen) { el.backdrop.classList.remove('open'); state.modalOpen = false; }
      }
    }

    // ===== Keyboard =====
    function onKey(e){
      if (state.modalOpen) return;
      if (e.key === ' '){ e.preventDefault(); onShuffle(); return; }
      if (e.key === 'Backspace' || e.key === 'Delete'){ e.preventDefault(); clearAll(); return; }
      const k = e.key.toUpperCase();
      if (/^[A-Z]$/.test(k)){
        // find first unused bank entry matching k
        const idx = state.bank.findIndex(b=>!b.used && b.ch === k);
        if (idx !== -1){ onLetterTap(idx); }
      }
    }

    // ===== Events =====
    el.shuffleBtn.addEventListener('click', onShuffle);
    el.clearBtn.addEventListener('click', clearAll);
    window.addEventListener('keydown', onKey);

    el.themeToggle.addEventListener('click', ()=> setTheme());

    el.retryBtn.addEventListener('click', ()=>{ el.retryBtn.disabled = true; setLoadingStatus('Retrying…', true); loadWordLists(); });
    el.playBtn.addEventListener('click', ()=>{ openModal(el.introModal,false); startRun(); });
    el.againBtn.addEventListener('click', ()=>{ openModal(el.overModal,false); startRun(); });

    // ===== Kickoff =====
    loadWordLists();
  })();
  </script>
</body>
</html>
