<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>JUMBL</title>
  <!--
  JUMBL v1.0 — Single-file build
  --------------------------------
  Drop this beside `answers.txt` and `guesses.txt` on a simple HTTP server (e.g. GitHub Pages).
  Both text files must be UPPERCASE, one word per line. answers.txt supplies the 5-letter
  letter bank per level; any valid 5-letter word in guesses.txt (or answers.txt) passes a level.

  Local note: `file://` will block fetch() in many browsers. Use a server:
    python3 -m http.server 8000   # then open http://localhost:8000/

  iOS focus/keyboard: Game is touch-first; desktop keyboard is optional.
  -->
  <style>
    :root {
      --bg: #0b0d10;           /* dark background */
      --fg: #e7ecf2;           /* foreground text */
      --muted: #9aa7b8;        /* subdued text */
      --tile: #171b21;         /* tile base */
      --tile-bright: #202733;  /* brighter tile */
      --accent-1: #6fb2ff;     /* gradient start */
      --accent-2: #b17dff;     /* gradient end */
      --danger: #ff5d7a;       /* danger/pink */
      --ok: #7dffa3;           /* success green */
      --tile-size: clamp(56px, 10vw, 76px);
      --gap: 10px;
      --radius: 16px;
      --shadow: 0 6px 20px rgba(0,0,0,0.3);
      --bar-h: 10px;
      --press: 0.985;          /* pressed scale */
      --anim-fast: 140ms;
      --anim-med: 200ms;
      --anim-slow: 320ms;
    }
    /* Light theme overrides */
    [data-theme="light"] {
      --bg: #f7f9fc;
      --fg: #111418;
      --muted: #5d6a7a;
      --tile: #ffffff;
      --tile-bright: #f1f5fb;
      --accent-1: #5b8cff;
      --accent-2: #ff73b6;
      --danger: #e0445e;
      --ok: #00a86b;
      --shadow: 0 3px 16px rgba(16, 22, 26, 0.15);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
      background: var(--bg);
      color: var(--fg);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      touch-action: manipulation;
    }

    .wrap {
      min-height: 100%;
      padding: calc(env(safe-area-inset-top) + 14px) 14px calc(env(safe-area-inset-bottom) + 16px);
      display: grid;
      grid-template-rows: auto auto auto auto 1fr auto;
      row-gap: 12px;
      max-width: 500px;
      margin: 0 auto;
    }

    /* Header */
    header {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
    }
    .title { text-align: center; font-weight: 800; letter-spacing: 2px; }
    .grad-text {
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .theme-toggle { justify-self: end; }

    button, .btn {
      -webkit-tap-highlight-color: transparent;
      border: none; outline: none; cursor: pointer; user-select: none;
      color: var(--fg); background: var(--tile);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: transform var(--anim-fast) ease, opacity var(--anim-fast) ease;
    }
    button:active { transform: scale(var(--press)); }

    /* Status row (level & lives) */
    .status {
      display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;
    }
    .level { font-weight: 700; }
    .lives { justify-self: center; display: grid; grid-auto-flow: column; gap: 6px; }
    .life {
      width: 18px; height: 18px; border-radius: 4px;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      box-shadow: 0 1px 4px rgba(0,0,0,0.25);
      transition: transform var(--anim-med), opacity var(--anim-med), filter var(--anim-med);
    }
    .life.lost { opacity: 0.25; filter: grayscale(1); transform: scale(0.85); }

    /* Timer */
    .timer {
      height: var(--bar-h);
      background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.06));
      border-radius: 999px; overflow: hidden; position: relative;
    }
    .timer .bar {
      position: absolute; inset: 0 0 0 0; transform-origin: left center; transform: scaleX(1);
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      will-change: transform; /* GPU-friendly */
    }
    .timer .label { position: absolute; inset: 0; display:flex; align-items:center; justify-content:center; font-size: 11px; color: var(--muted); }

    /* Answer row */
    .answer {
      display: grid; grid-template-columns: repeat(5, 1fr); gap: var(--gap);
    }
    .slot {
      width: 100%; aspect-ratio: 1 / 1; border-radius: calc(var(--radius) * 1.25);
      background: var(--tile); display:grid; place-items:center; font-weight:800; font-size: clamp(22px, 7vw, 28px);
      box-shadow: var(--shadow);
      position: relative; overflow: hidden;
    }
    .slot.filled { background: var(--tile-bright); }

    /* Letter bank */
    .bank {
      display: grid; grid-template-columns: repeat(5, 1fr); gap: var(--gap);
    }
    .letter {
      width: 100%; aspect-ratio: 1 / 1; display:grid; place-items:center;
      font-weight: 800; font-size: clamp(22px, 7vw, 28px);
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      color: #0b0d10; border-radius: calc(var(--radius) * 1.25);
      box-shadow: var(--shadow);
      position: relative; isolation: isolate;
    }
    .letter[aria-disabled="true"] { opacity: 0.35; filter: grayscale(0.4); pointer-events: none; }
    .bank.jiggle { animation: jiggle var(--anim-slow) ease; }

    /* Controls */
    .controls {
      display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap);
    }
    .control-btn { height: max(44px, 9vh); font-size: clamp(16px, 4.2vw, 20px); font-weight: 800; }
    .ghost { background: transparent; border: 2px solid rgba(255,255,255,0.08); }

    /* Modals */
    .modal { position: fixed; inset: 0; display: none; z-index: 20; }
    .modal.open { display: block; }
    .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
    .sheet {
      position: absolute; inset: auto 14px calc(env(safe-area-inset-bottom) + 14px) 14px;
      background: var(--tile-bright); color: var(--fg);
      border-radius: 20px; box-shadow: var(--shadow);
      padding: 16px 16px 10px; max-width: 520px; margin: 0 auto; left: 0; right: 0;
      transform: translateY(16px); animation: rise var(--anim-slow) ease both;
    }
    .sheet h2 { margin: 0 0 8px; text-align:center; }
    .sheet p { margin: 6px 0; color: var(--muted); }
    .sheet .actions { display:grid; grid-auto-flow: column; gap: 8px; margin-top: 12px; }

    /* Accessibility helpers */
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

    /* Animations */
    @keyframes rise { from { opacity: 0; transform: translateY(20px);} to { opacity:1; transform: translateY(0);} }
    @keyframes shakeX { 0%,100%{ transform: translateX(0);} 20%{ transform: translateX(-6px);} 40%{ transform: translateX(6px);} 60%{ transform: translateX(-4px);} 80%{ transform: translateX(4px);} }
    @keyframes pop { from { transform: scale(0.85);} to { transform: scale(1);} }
    @keyframes popwiggle { 0%{ transform: scale(0.85) rotate(0deg);} 40%{ transform: scale(1.06) rotate(1.5deg);} 70%{ transform: scale(1.02) rotate(-1.5deg);} 100%{ transform: scale(1);} }
    @keyframes jiggle { 0%{ transform: rotate(0);} 30%{ transform: rotate(-2.5deg);} 60%{ transform: rotate(2.5deg);} 100%{ transform: rotate(0);} }

    .answer.shake { animation: shakeX 260ms ease; }
    .slot.pop { animation: pop var(--anim-med) ease; }
    .slot.correct { animation: popwiggle 380ms ease both; }

    @media (prefers-reduced-motion: reduce) {
      * { transition-duration: 0.01ms !important; animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; }
    }
  </style>
</head>
<body>
  <div class="wrap" id="app" aria-live="off">
    <header>
      <div></div>
      <div class="title grad-text" aria-label="JUMBL title">JUMBL</div>
      <div class="theme-toggle">
        <button id="themeBtn" class="btn" aria-label="Toggle theme" title="Toggle theme" style="padding:8px 12px; font-weight:700;">
          ☀︎/☾
        </button>
      </div>
    </header>

    <div class="status" aria-label="game status">
      <div class="level" id="levelLabel">Level 1</div>
      <div class="lives" id="lives" aria-label="Lives">
        <div class="life" data-index="0"></div>
        <div class="life" data-index="1"></div>
        <div class="life" data-index="2"></div>
      </div>
      <div></div>
    </div>

    <div class="timer" aria-label="Timer">
      <div class="bar" id="timeBar"></div>
      <div class="label" aria-hidden="true" id="timeText">25.0s</div>
      <div class="sr-only" role="status" aria-live="polite" id="timeAria">25 seconds remaining</div>
    </div>

    <div class="answer" id="answer" aria-label="Answer row"></div>

    <div class="bank" id="bank" aria-label="Letter bank"></div>

    <div class="controls">
      <button id="shuffleBtn" class="control-btn btn" aria-label="Shuffle letters" title="Shuffle (Space)">⤮ Shuffle</button>
      <button id="backBtn" class="control-btn btn ghost" aria-label="Backspace" title="Backspace (⌫)">⌫ Back</button>
    </div>
  </div>

  <!-- Intro Modal -->
  <div id="introModal" class="modal open" aria-modal="true" role="dialog">
    <div class="overlay"></div>
    <div class="sheet">
      <h2 class="grad-text">RULES</h2>
      <div class="content">
        <p>Make a valid five-letter word from the jumbl’d letters.</p>
        <p><strong>Auto-submit:</strong> when 5 letters are placed:
          <br>• If it’s in the word list → <strong>Success</strong>. Next level, new letters, timer refills.
          <br>• If not accepted → <strong>Invalid</strong>. Quick shake + clear. No life lost.</p>
        <p><strong>Timer:</strong> 25s per word. Hitting 0 costs 1 life, refreshes new letters (same level), timer restarts.</p>
        <p><strong>Lives:</strong> 3 total. On zero, it’s game over.</p>
        <p class="muted" style="color:var(--muted)">Touch-first. Keyboard (desktop): A–Z uses matching unused bank letter; Space = Shuffle; Backspace = Undo.</p>
        <p id="loadStatus" style="font-size:12px; color:var(--muted); margin-top:8px;">Loading word lists…</p>
      </div>
      <div class="actions">
        <button id="playBtn" class="btn" disabled>Play</button>
      </div>
    </div>
  </div>

  <!-- Game Over Modal -->
  <div id="gameOverModal" class="modal" aria-modal="true" role="dialog">
    <div class="overlay"></div>
    <div class="sheet">
      <h2 class="grad-text">Game Over</h2>
      <p id="summary">You reached level 0.</p>
      <div class="actions">
        <button id="retryBtn" class="btn">try again ➜</button>
      </div>
    </div>
  </div>

  <!-- Loading/Retry Modal -->
  <div id="loadErrorModal" class="modal" aria-modal="true" role="dialog">
    <div class="overlay"></div>
    <div class="sheet">
      <h2 class="grad-text">Can’t load lists</h2>
      <p>We couldn’t fetch <code>answers.txt</code> / <code>guesses.txt</code>. Make sure you’re serving over HTTP (not <code>file://</code>) and the files are next to this page.</p>
      <div class="actions">
        <button id="retryLoadBtn" class="btn">Retry</button>
      </div>
    </div>
  </div>

  <script>
  (() => {
    'use strict';
    // ---------------------------
    // State & Data
    // ---------------------------
    const TIMER_MS = 25_000;

    /** @type {Set<string>} */ let ACCEPTED_SET = new Set();
    /** @type {string[]}      */ let ANSWER_POOL = [];
    /** @type {Set<string>}   */ let ANSWER_SET = new Set();

    /** bank letters with usage flags */
    /** @type {{ch:string, used:boolean}[]} */ let bank = [];
    /** current built guess as {ch, bankIndex} */
    /** @type {{ch:string, bankIndex:number}[]} */ let current = [];

    let lives = 3;
    let level = 1;              // current level index (1-based)
    let wordDeadlineAt = 0;     // performance.now() deadline
    let rafId = 0;              // rAF handle
    let isAnimating = false;    // input guard during short celebratory anims

    // ---------------------------
    // Elements
    // ---------------------------
    const el = (id) => document.getElementById(id);
    const answerEl = el('answer');
    const bankEl   = el('bank');
    const levelEl  = el('levelLabel');
    const livesEl  = el('lives');
    const timeBar  = el('timeBar');
    const timeLbl  = el('timeText');
    const timeAria = el('timeAria');

    const introModal = el('introModal');
    const playBtn    = el('playBtn');
    const loadStatus = el('loadStatus');

    const overModal  = el('gameOverModal');
    const summary    = el('summary');
    const retryBtn   = el('retryBtn');

    const loadErrModal = el('loadErrorModal');
    const retryLoadBtn = el('retryLoadBtn');

    const shuffleBtn = el('shuffleBtn');
    const backBtn    = el('backBtn');
    const themeBtn   = el('themeBtn');

    // ---------------------------
    // Theme persistence
    // ---------------------------
    const THEME_KEY = 'jumbl-theme';
    function applyTheme(theme) { document.body.setAttribute('data-theme', theme); }
    function getStoredTheme() { return sessionStorage.getItem(THEME_KEY) || 'dark'; }
    function setStoredTheme(theme) { try { sessionStorage.setItem(THEME_KEY, theme); } catch(_){} }
    applyTheme(getStoredTheme());
    themeBtn.addEventListener('click', () => {
      const cur = document.body.getAttribute('data-theme') || 'dark';
      const next = cur === 'dark' ? 'light' : 'dark';
      applyTheme(next); setStoredTheme(next);
    }, { passive: true });

    // ---------------------------
    // Utility
    // ---------------------------
    const randInt = (n) => Math.floor(Math.random() * n);
    function fisherYates(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    const clamp01 = (x) => x < 0 ? 0 : (x > 1 ? 1 : x);
    const mmss = (ms) => {
      const s = Math.ceil(ms / 100) / 10; // 0.1s resolution
      return s.toFixed(1) + 's';
    };

    // ---------------------------
    // Rendering
    // ---------------------------
    function renderLives() {
      [...livesEl.children].forEach((node, idx) => {
        node.classList.toggle('lost', idx >= lives);
      });
      livesEl.setAttribute('aria-label', `Lives: ${lives}`);
    }

    function renderLevel() {
      levelEl.textContent = `Level ${level}`;
    }

    function renderAnswer() {
      // Build 5 slots; filled show letters
      answerEl.innerHTML = '';
      for (let i = 0; i < 5; i++) {
        const slot = document.createElement('div');
        slot.className = 'slot' + (current[i] ? ' filled' : '');
        if (current[i]) slot.textContent = current[i].ch;
        slot.setAttribute('data-index', String(i));
        answerEl.appendChild(slot);
      }
    }

    function renderBank() {
      bankEl.innerHTML = '';
      bank.forEach((b, idx) => {
        const btn = document.createElement('button');
        btn.className = 'letter';
        btn.type = 'button';
        btn.textContent = b.ch;
        btn.setAttribute('data-index', String(idx));
        btn.setAttribute('aria-disabled', b.used ? 'true' : 'false');
        btn.addEventListener('click', onLetterTap, { passive: true });
        bankEl.appendChild(btn);
      });
    }

    function animateAnswerPopAt(idx) {
      const slot = answerEl.children[idx];
      if (!slot) return;
      slot.classList.remove('pop'); // restart
      void slot.offsetWidth; // flush
      slot.classList.add('pop');
    }

    function animateAnswerCorrect() {
      // Stagger across 5 tiles
      [...answerEl.children].forEach((slot, i) => {
        setTimeout(() => {
          slot.classList.add('correct');
          setTimeout(() => slot.classList.remove('correct'), 380);
        }, i * 40);
      });
    }

    function animateAnswerShakeAndClear() {
      answerEl.classList.add('shake');
      setTimeout(() => {
        answerEl.classList.remove('shake');
        clearGuess();
      }, 260);
    }

    function jiggleBankOnce() {
      bankEl.classList.add('jiggle');
      setTimeout(() => bankEl.classList.remove('jiggle'), 320);
    }

    // ---------------------------
    // Game Loop & Timer
    // ---------------------------
    function startTimer(full = true) {
      const now = performance.now();
      if (full || wordDeadlineAt <= now) wordDeadlineAt = now + TIMER_MS;
      cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(tick);
    }

    function stopTimer() {
      cancelAnimationFrame(rafId);
    }

    let lastAriaEmit = 0;
    function tick() {
      const now = performance.now();
      const remaining = wordDeadlineAt - now;
      const ratio = clamp01(remaining / TIMER_MS);
      timeBar.style.transform = `scaleX(${ratio})`;

      // Visible minimal label (non-intrusive)
      timeLbl.textContent = mmss(Math.max(0, remaining));

      // Polite aria status ~every 600ms to limit chatter
      if (now - lastAriaEmit > 600) {
        lastAriaEmit = now;
        const s = Math.max(0, Math.ceil(remaining / 1000));
        timeAria.textContent = `${s} seconds remaining`;
      }

      if (remaining <= 0) {
        onTimeout();
        return; // onTimeout restarts timer or ends game
      }
      rafId = requestAnimationFrame(tick);
    }

    // ---------------------------
    // Round Management
    // ---------------------------
    function pickNewBankFromRandomAnswer() {
      const answer = ANSWER_POOL[randInt(ANSWER_POOL.length)];
      // Create letter bag of 5 chars
      bank = answer.split('').map(ch => ({ ch, used: false }));
      fisherYates(bank);
      current = [];
      renderAnswer();
      renderBank();
    }

    function nextLevel() {
      level += 1;
      renderLevel();
      pickNewBankFromRandomAnswer();
      startTimer(true);
    }

    function refreshLettersSameLevel() {
      pickNewBankFromRandomAnswer();
      startTimer(true);
    }

    function resetGame() {
      lives = 3; level = 1; isAnimating = false; current = [];
      renderLives(); renderLevel();
      pickNewBankFromRandomAnswer();
      startTimer(true);
    }

    // ---------------------------
    // Input Handlers
    // ---------------------------
    function onLetterTap(e) {
      if (isAnimating) return;
      const idx = Number(e.currentTarget.getAttribute('data-index'));
      const node = bank[idx];
      if (!node || node.used) return;
      // place into next slot
      if (current.length >= 5) return;
      node.used = true;
      current.push({ ch: node.ch, bankIndex: idx });
      renderAnswer();
      renderBank();
      animateAnswerPopAt(current.length - 1);
      if (current.length === 5) autoSubmit();
    }

    function onBackspace() {
      if (isAnimating) return;
      if (current.length === 0) return;
      const popped = current.pop();
      if (popped && bank[popped.bankIndex]) bank[popped.bankIndex].used = false;
      renderAnswer();
      renderBank();
    }

    function onShuffle() {
      if (isAnimating) return;
      const usedIndices = new Set(current.map(c => c.bankIndex));
      const unused = [];
      const positions = [];
      bank.forEach((b, i) => { if (!usedIndices.has(i)) { unused.push(b); positions.push(i); } });
      fisherYates(unused);
      // Put shuffled unused back into their positions
      positions.forEach((pos, i) => { bank[pos] = unused[i]; });
      renderBank();
      jiggleBankOnce();
    }

    function onKeyDown(e) {
      if (isAnimating) return;
      const key = e.key;
      if (key === 'Backspace') { e.preventDefault(); onBackspace(); return; }
      if (key === ' ' || key === 'Spacebar') { e.preventDefault(); onShuffle(); return; }
      const m = /^[a-zA-Z]$/.exec(key);
      if (m) {
        const ch = m[0].toUpperCase();
        // use first matching unused bank letter
        for (let i = 0; i < bank.length; i++) {
          if (!bank[i].used && bank[i].ch === ch) {
            // Simulate tap on this bank index
            bank[i].used = true;
            current.push({ ch, bankIndex: i });
            renderAnswer();
            renderBank();
            animateAnswerPopAt(current.length - 1);
            if (current.length === 5) autoSubmit();
            break;
          }
        }
      }
    }

    // ---------------------------
    // Submission & Outcomes
    // ---------------------------
    function clearGuess() {
      // free used bank letters
      current.forEach(c => { if (bank[c.bankIndex]) bank[c.bankIndex].used = false; });
      current = [];
      renderAnswer();
      renderBank();
    }

    function autoSubmit() {
      const word = current.map(c => c.ch).join('');
      // Accept if in guesses OR answers (both uppercase)
      if (ACCEPTED_SET.has(word)) {
        isAnimating = true;
        animateAnswerCorrect();
        // brief celebrate then next level
        setTimeout(() => {
          isAnimating = false;
          nextLevel();
        }, 420);
      } else {
        // invalid → shake + clear, keep same timer/level
        animateAnswerShakeAndClear();
      }
    }

    function onTimeout() {
      lives -= 1;
      renderLives();
      if (lives <= 0) {
        stopTimer();
        // X = levels completed
        const completed = Math.max(0, level - 1);
        summary.textContent = `You reached level ${completed}.`;
        overModal.classList.add('open');
        return;
      }
      // Refresh new letters, same level
      refreshLettersSameLevel();
    }

    // ---------------------------
    // Loading word lists
    // ---------------------------
    async function fetchList(path) {
      const res = await fetch(path, { cache: 'no-store' });
      if (!res.ok) throw new Error(`Failed to fetch ${path}: ${res.status}`);
      const text = await res.text();
      // Parse lines, keep UPPERCASE A–Z 5-letter words only
      const out = [];
      const lines = text.split(/\r?\n/);
      for (let line of lines) {
        line = line.trim().toUpperCase();
        if (/^[A-Z]{5}$/.test(line)) out.push(line);
      }
      return out;
    }

    async function loadLists() {
      try {
        loadStatus.textContent = 'Loading word lists…';
        const [ans, gss] = await Promise.all([
          fetchList('answers.txt'),
          fetchList('guesses.txt'),
        ]);
        ANSWER_POOL = ans;
        ANSWER_SET = new Set(ans);
        ACCEPTED_SET = new Set([...gss, ...ans]);
        loadStatus.textContent = `Loaded ${ans.length.toLocaleString()} answers, ${gss.length.toLocaleString()} guesses.`;
        playBtn.disabled = false;
      } catch (err) {
        console.error(err);
        introModal.classList.remove('open');
        loadErrModal.classList.add('open');
      }
    }

    // ---------------------------
    // Wiring
    // ---------------------------
    playBtn.addEventListener('click', () => {
      introModal.classList.remove('open');
      resetGame();
    }, { passive: true });

    retryBtn.addEventListener('click', () => {
      overModal.classList.remove('open');
      resetGame();
    }, { passive: true });

    retryLoadBtn.addEventListener('click', () => {
      loadErrModal.classList.remove('open');
      introModal.classList.add('open');
      playBtn.disabled = true;
      loadLists();
    }, { passive: true });

    shuffleBtn.addEventListener('click', onShuffle, { passive: true });
    backBtn.addEventListener('click', onBackspace, { passive: true });
    document.addEventListener('keydown', onKeyDown);

    // Prevent long-press callout/select on iOS
    ['bank','answer','app'].forEach(id => {
      const n = el(id);
      if (n) {
        n.style.webkitUserSelect = 'none';
        n.style.userSelect = 'none';
        n.style.webkitTouchCallout = 'none';
      }
    });

    // Kick off loading
    loadLists();
  })();
  </script>
</body>
</html>
