<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>JUMBL</title>
  <style>
    /* ------------------------------
       0) Base / Theme / Resets
       ------------------------------ */
    :root{
      color-scheme: light dark;
      --bg:#F6F7FB; --fg:#0F1220; --muted:#6B7280; --track:#ECECEC;
      --tile-bg:#FFFFFF; --tile-fg:#111827; --btn-bg:#FFFFFF; --btn-fg:#0F1220;
      --accent:#3B82F6; --danger:#EF4444; --shadow:0 6px 20px rgba(0,0,0,.08); --radius:16px;
      --gap:10px;
      --maxw:600px;
    }
    html.dark{
      color-scheme: dark;
      --bg:#0F1115; --fg:#E6E7EB; --muted:#9AA1AA; --track:#1F2430;
      --tile-bg:#171A20; --tile-fg:#F7F7FA; --btn-bg:#171A20; --btn-fg:#E6E7EB;
      --accent:#7CB2FF; --danger:#FF6B88; --shadow:0 8px 24px rgba(0,0,0,.35); --radius:16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font: 16px/1.4 system-ui,-apple-system, "SF Pro Text", Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      -webkit-tap-highlight-color: transparent; /* keep focus outlines via :focus-visible */
      height:100dvh; min-height:100dvh; overflow:hidden; overscroll-behavior:none;
    }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    /* Dynamic viewport sizing */
    :root{ --vh:100vh; --vw:100vw; }

    /* App shell */
    .app{
      width: min(var(--vw, 100vw), var(--maxw));
      margin: 0 auto;
      padding:
        calc(env(safe-area-inset-top) + 16px)
        16px
        calc(env(safe-area-inset-bottom) + 18px);
      display:grid; grid-template-rows:auto auto auto auto auto auto auto 1fr; gap:14px;
    }

    /* Header */
    .header{ display:grid; grid-template-columns:1fr auto 1fr; align-items:center; }
    .title{ text-align:center; font-weight:800; letter-spacing:0.12em; font-size: clamp(18px, 2.4vw, 22px); }
    .theme-wrap{ justify-self:end; }
    .icon-btn{
      appearance:none; border:1px solid transparent; background:var(--btn-bg); color:var(--btn-fg);
      border-radius:12px; padding:10px; box-shadow:var(--shadow); cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      transition: transform .08s ease, box-shadow .08s ease; /* press animation */
    }
    .icon-btn:active{ transform: scale(.96); box-shadow: 0 2px 10px rgba(0,0,0,.12); }
    .icon{ width:20px; height:20px; display:block; }

    /* Lives */
    .lives{ display:flex; gap:10px; justify-content:center; align-items:center; }
    .pip{ width:10px; height:10px; border-radius:50%; background:currentColor; opacity:.3; }
    .pip.on{ opacity:1; }

    /* Level */
    .level{ text-align:center; color:var(--muted); font-weight:600; }

    /* Timer */
    .timer-card{ background:var(--btn-bg); border-radius: var(--radius); padding:12px; box-shadow:var(--shadow); }
    .timer{
      height:14px; background:var(--track); border-radius:9999px; position:relative; overflow:hidden;
    }
    .fill{
      position:absolute; left:0; top:0; bottom:0; width:100%;
      background:var(--accent); border-radius:9999px;
      transition: width 100ms linear; /* TICK_MS */
    }

    /* Rows (Answer above Bank) */
    .row{ display:grid; grid-template-columns: repeat(5, 1fr); gap: var(--gap); }
    .tile, .bank-btn{
      background:var(--tile-bg); color:var(--tile-fg); border:1px solid transparent;
      border-radius:14px; display:grid; place-items:center; font-weight:800; font-size: clamp(20px, 5vw, 28px);
      aspect-ratio:1/1; min-width:56px; min-height:56px; box-shadow:var(--shadow);
      user-select:none;
    }
    .tile.locked{ opacity:.96; outline:2px solid var(--muted); }
    .tile.empty{ color:transparent; }

    .bank-btn{ cursor:pointer; }
    .bank-btn[disabled]{ opacity:.35; cursor:not-allowed; }

    /* Controls */
    .controls{ display:grid; grid-template-columns:1fr 1fr; gap: var(--gap); }
    .btn{
      appearance:none; border:1px solid transparent; background:var(--btn-bg); color:var(--btn-fg);
      border-radius:16px; padding:14px; font-weight:700; box-shadow:var(--shadow); cursor:pointer;
      transition: transform .1s ease, box-shadow .1s ease;
    }
    .btn:active{ transform: scale(.96); box-shadow: 0 2px 10px rgba(0,0,0,.12); }
    /* Prevent iOS double-tap-to-zoom on buttons */
button{ touch-action: manipulation; }

    /* Animations (GPU-friendly, motion-only) */
    @keyframes pop { 0%{transform:scale(.92)} 100%{transform:scale(1)} }
    @keyframes shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-6px)} 40%{transform:translateX(6px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }
    @keyframes jiggle { 0%,100%{transform:translateY(0)} 25%{transform:translateY(-2px)} 75%{transform:translateY(2px)} }
    @keyframes shudder { 0%,100%{transform:translateX(0)} 10%{transform:translateX(-2px)} 20%{transform:translateX(2px)} 30%{transform:translateX(-2px)} 40%{transform:translateX(2px)} 50%{transform:translateX(-1px)} 60%{transform:translateX(1px)} 70%{transform:translateX(-1px)} 80%{transform:translateX(1px)} 90%{transform:translateX(0)} }

    .pop{ animation: pop .2s ease both; }
    .shake{ animation: shake .22s ease both; }
    .jiggle{ animation: jiggle .26s ease both; }
    .shudder{ animation: shudder .8s ease both; }

    /* Exaggerated win pop (only on correct answer) */
    @keyframes popwin { 
      0%   { transform: scale(.85) } 
      60%  { transform: scale(1.12) }  /* increase this to 1.15+ for more oomph */
      100% { transform: scale(1) } 
    }
    .popwin{ animation: popwin .34s cubic-bezier(.2,.7,.2,1) both; } /* lengthen for slower pop */

    @media (prefers-reduced-motion: reduce){
      .pop,.shake,.jiggle,.shudder{ animation-duration:.05s; animation-iteration-count:1; }
      .fill{ transition:none; }
    }

    /* Modals */
    .backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:10; }
    .backdrop.show{ display:grid; place-items:center; }
    .modal{ width:min(92vw, 520px); background:var(--btn-bg); color:var(--btn-fg); border-radius:24px; padding:22px; box-shadow:var(--shadow); }
    .modal h2{ margin:0 0 8px; font-size:20px; }
    .modal p{ margin:10px 0; color:var(--muted); }
    .modal .actions{ margin-top:14px; display:flex; gap:10px; justify-content:flex-end; }

    /* Focus visible outlines retained */
    :focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px; }
  </style>
</head>
<body>
  <div class="app" id="app" aria-live="polite">
    <!-- 1) Header -->
    <header class="header">
      <div></div>
      <div class="title" aria-label="Game title">JUMBL</div>
      <div class="theme-wrap">
        <button class="icon-btn" id="themeToggle" aria-label="Toggle theme" title="Toggle theme">
          <svg class="icon" id="iconSun" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 4.5a1 1 0 0 1 1 1V7a1 1 0 1 1-2 0V5.5a1 1 0 0 1 1-1Zm0 11a3.5 3.5 0 1 1 0-7 3.5 3.5 0 0 1 0 7Zm7.5-3.5a1 1 0 0 1 1 1V14a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1ZM12 17a1 1 0 0 1 1 1v1.5a1 1 0 1 1-2 0V18a1 1 0 0 1 1-1ZM4.5 12a1 1 0 0 1 1-1H7a1 1 0 1 1 0 2H5.5a1 1 0 0 1-1-1Zm10.95-5.657a1 1 0 0 1 1.414 0l1.06 1.06a1 1 0 1 1-1.413 1.415l-1.061-1.06a1 1 0 0 1 0-1.415Zm0 11.314a1 1 0 0 1 1.414 0l1.06 1.06a1 1 0 1 1-1.413 1.415l-1.061-1.06a1 1 0 0 1 0-1.415ZM6.076 6.904a1 1 0 0 1 1.415 0L8.55 7.964A1 1 0 1 1 7.136 9.38L6.076 8.318a1 1 0 0 1 0-1.414Zm0 10.192a1 1 0 0 1 1.415 0l1.06 1.06A1 1 0 0 1 7.136 19.57l-1.06-1.06a1 1 0 0 1 0-1.414Z"/></svg>
          <svg class="icon" id="iconMoon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" style="display:none"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79Z"/></svg>
        </button>
      </div>
    </header>

    <!-- 2) Lives -->
    <div class="lives" aria-label="Lives">
      <span class="pip" id="pip1"></span>
      <span class="pip" id="pip2"></span>
      <span class="pip" id="pip3"></span>
      <span class="sr-only" id="livesText">Lives: 3 of 3</span>
    </div>

    <!-- 3) Level label -->
    <div class="level" id="level">Level 1</div>

    <!-- 4) Timer -->
    <div class="timer-card">
      <div class="timer" role="progressbar" aria-valuemin="0" aria-valuemax="25" aria-valuenow="25" aria-label="Time remaining">
        <div class="fill" id="timerFill" style="width:100%"></div>
      </div>
    </div>

    <!-- 5) Answer row (above) -->
    <div class="row" id="answerRow" aria-label="Your guess"></div>

    <!-- 6) Letter bank (below) -->
    <div class="row" id="bankRow" aria-label="Letter bank"></div>

    <!-- 7) Controls -->
    <div class="controls">
      <button class="btn" id="btnShuffle" aria-label="Shuffle letters">Shuffle</button>
      <button class="btn" id="btnClear" aria-label="Clear all">Clear all</button>
    </div>

    <!-- spacer -->
    <div></div>
  </div>

  <!-- ARIA live announcer -->
  <div class="sr-only" id="announcer" aria-live="polite"></div>

  <!-- Loading / Retry modal -->
  <div class="backdrop" id="loadingBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loadingTitle">
      <h2 id="loadingTitle">Loading word lists…</h2>
      <p id="loadingText">Fetching…</p>
      <div class="actions">
        <button class="btn" id="btnRetry" disabled>Retry</button>
      </div>
    </div>
  </div>

  <!-- Intro / Rules modal -->
  <div class="backdrop" id="introBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="rulesTitle">
      <h2 id="rulesTitle">Rules</h2>
      <p>Make a real 5-letter word<br>
         Correct: level up + timer refills<br>
         Real but wrong: −1 life; matches lock<br>
         Time’s up: reveal + −1 life</p>
      <p>25 seconds per word • 3 lives</p>
      <div class="actions">
        <button class="btn" id="btnPlay">Play</button>
      </div>
    </div>
  </div>

  <!-- Game Over modal -->
  <div class="backdrop" id="gameoverBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="goTitle">
      <h2 id="goTitle">Game over</h2>
      <p id="goBody">You reached level 0</p>
      <div class="actions">
        <button class="btn" id="btnAgain">Play again</button>
      </div>
    </div>
  </div>

  <script>
  // ------------------------------
  // 1) Constants & State
  // ------------------------------
  const COUNTDOWN_SECONDS = 25;
  const STARTING_LIVES = 3;
  const TICK_MS = 100;

  const state = {
    // word lists
    ANSWER_POOL: [],
    ACCEPTED_SET: new Set(),

    // authoritative game state
    answerWord: '',
    bank: [], // [{ch, used}] length 5
    current: Array(5).fill(''),
    locked: Array(5).fill(false),
    placedIndex: Array(5).fill(null), // slot -> bank index

    lives: STARTING_LIVES,
    level: 1,
    runStartAt: 0,

    deadlineAt: 0,
    timerHandle: null,
    lastAnnouncedSec: COUNTDOWN_SECONDS,
    isAnimating: false,

    // UI guards
    inputsDisabled: false,
    listsLoaded: false,
  };

  // ------------------------------
  // 2) Utilities
  // ------------------------------
  const $ = sel => document.querySelector(sel);
  const app = $('#app');
  const answerRow = $('#answerRow');
  const bankRow = $('#bankRow');
  const levelEl = $('#level');
  const timerFill = $('#timerFill');
  const announcer = $('#announcer');
  const livesText = $('#livesText');

  // Modals
  const loadingBackdrop = $('#loadingBackdrop');
  const loadingText = $('#loadingText');
  const btnRetry = $('#btnRetry');
  const introBackdrop = $('#introBackdrop');
  const btnPlay = $('#btnPlay');
  const gameoverBackdrop = $('#gameoverBackdrop');
  const goBody = $('#goBody');
  const btnAgain = $('#btnAgain');

  // Controls
  const btnShuffle = $('#btnShuffle');
  const btnClear = $('#btnClear');

  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
  function randInt(n){ return Math.floor(Math.random()*n); }
  function shuffleArray(arr){
    for(let i=arr.length-1;i>0;i--){ const j = randInt(i+1); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    return arr;
  }
  function announce(txt){ announcer.textContent = txt; }
  function setBackdrop(backdrop, show){ backdrop.classList.toggle('show', !!show); if(show){
      const btn = backdrop.querySelector('button'); if(btn) setTimeout(()=>btn.focus(), 0);
    } }

  // ------------------------------
  // 3) Theme (sessionStorage: 'jumbl-theme')
  // ------------------------------
  const THEME_KEY = 'jumbl-theme';
  function applyTheme(theme){
    const isDark = theme === 'dark';
    document.documentElement.classList.toggle('dark', isDark);
    // swap icon visibility
    $('#iconSun').style.display = isDark ? 'none':'block';
    $('#iconMoon').style.display = isDark ? 'block':'none';
  }
  function initTheme(){
    let t = sessionStorage.getItem(THEME_KEY);
    if(!t){ t = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'; }
    applyTheme(t);
  }
  $('#themeToggle').addEventListener('click', ()=>{
    const nowDark = !document.documentElement.classList.contains('dark');
    applyTheme(nowDark ? 'dark' : 'light');
    sessionStorage.setItem(THEME_KEY, nowDark ? 'dark' : 'light');
  });

  // ------------------------------
  // 4) Dynamic viewport vars (--vh, --vw)
  // ------------------------------
  function updateViewportVars(){
    const vv = window.visualViewport;
    const w = vv ? vv.width : window.innerWidth;
    const h = vv ? vv.height : window.innerHeight;
    document.documentElement.style.setProperty('--vw', w + 'px');
    document.documentElement.style.setProperty('--vh', h + 'px');
  }
  updateViewportVars();
  window.addEventListener('resize', updateViewportVars, {passive:true});
  window.addEventListener('orientationchange', updateViewportVars, {passive:true});
  window.addEventListener('pageshow', updateViewportVars, {passive:true});
  if(window.visualViewport){ visualViewport.addEventListener('resize', updateViewportVars, {passive:true}); visualViewport.addEventListener('scroll', updateViewportVars, {passive:true}); }

  // ------------------------------
  // 5) Loading word lists
  // ------------------------------
  async function loadWordLists(){
    setBackdrop(loadingBackdrop, true);
    loadingText.textContent = 'Fetching…';
    btnRetry.disabled = true;
    try{
      const [aRes, gRes] = await Promise.all([
        fetch('answers.txt', {cache:'no-store'}),
        fetch('guesses.txt', {cache:'no-store'})
      ]);
      if(!aRes.ok || !gRes.ok) throw new Error('HTTP error');
      const [aText, gText] = await Promise.all([aRes.text(), gRes.text()]);
      const re = /^[A-Z]{5}$/;
      const answers = aText.split(/\r?\n/).map(s=>s.trim().toUpperCase()).filter(s=>re.test(s));
      const guesses = gText.split(/\r?\n/).map(s=>s.trim().toUpperCase()).filter(s=>re.test(s));
      if(!answers.length || !guesses.length) throw new Error('Empty lists');
      state.ANSWER_POOL = answers;
      state.ACCEPTED_SET = new Set(guesses);
      state.listsLoaded = true;
      loadingText.textContent = `Loaded ${answers.length} answers, ${guesses.length} guesses.`;
      setTimeout(()=>{ setBackdrop(loadingBackdrop, false); setBackdrop(introBackdrop, true); }, 400);
    }catch(err){
      loadingText.innerHTML = 'Could not load word lists.\n\nTip: Serve files over HTTP (e.g., <code>python3 -m http.server</code>) and ensure <code>answers.txt</code> and <code>guesses.txt</code> are beside <code>index.html</code>.';
      btnRetry.disabled = false;
    }
  }
  $('#btnRetry').addEventListener('click', ()=> loadWordLists());

  // ------------------------------
  // 6) Rendering helpers
  // ------------------------------
  function renderLives(){
    for(let i=1;i<=3;i++){
      const el = $('#pip'+i);
      el.classList.toggle('on', i <= state.lives);
    }
    livesText.textContent = `Lives: ${state.lives} of ${STARTING_LIVES}`;
  }

  function renderLevel(){ levelEl.textContent = `Level ${state.level}`; }

  function renderAnswerRow(){
    answerRow.innerHTML = '';
    state.current.forEach((ch, i)=>{
      const div = document.createElement('div');
      div.className = 'tile' + (state.locked[i] ? ' locked' : ch ? '' : ' empty');
      div.textContent = ch || '•';
      div.dataset.slot = i;
      answerRow.appendChild(div);
    });
  }

  function renderBankRow(){
    bankRow.innerHTML='';
    state.bank.forEach((b,i)=>{
      const btn = document.createElement('button');
      btn.className = 'bank-btn';
      btn.type = 'button';
      btn.textContent = b.ch;
      btn.disabled = b.used || state.inputsDisabled;
      btn.dataset.idx = i;
      btn.addEventListener('click', ()=> onLetterTap(i));
      bankRow.appendChild(btn);
    });
  }

  function renderTimer(nowMs){
    const remainMs = clamp(state.deadlineAt - nowMs, 0, COUNTDOWN_SECONDS*1000);
    const pct = (remainMs / (COUNTDOWN_SECONDS*1000)) * 100;
    timerFill.style.width = pct + '%'; // left-anchored, drains right -> left
    const remainSec = Math.ceil(remainMs/1000);
    const pb = document.querySelector('.timer[role="progressbar"]');
    pb.setAttribute('aria-valuenow', String(clamp(remainSec,0,COUNTDOWN_SECONDS)));
    if(remainSec !== state.lastAnnouncedSec && remainSec >= 0){
      state.lastAnnouncedSec = remainSec;
      announce(`${remainSec} seconds remaining`);
    }
  }

  function renderUI(){
    renderLives();
    renderLevel();
    renderAnswerRow();
    renderBankRow();
  }

  // ------------------------------
  // 7) Timer controls
  // ------------------------------
  function startTimer(){
    stopTimer();
    state.lastAnnouncedSec = COUNTDOWN_SECONDS;
    state.deadlineAt = performance.now() + COUNTDOWN_SECONDS*1000;
    renderTimer(performance.now());
    state.timerHandle = setInterval(()=>{
      const now = performance.now();
      renderTimer(now);
      if(now >= state.deadlineAt){ stopTimer(); onTimeout(); }
    }, TICK_MS);
  }
  function stopTimer(){ if(state.timerHandle){ clearInterval(state.timerHandle); state.timerHandle=null; } }

  // ------------------------------
  // 8) Bank & Next word
  // ------------------------------
  function buildBankFrom(answer){
    const letters = answer.split('');
    shuffleArray(letters);
    return letters.map(ch=>({ch, used:false}));
  }

  function nextWord(increment){
    state.inputsDisabled = false;
    if(increment) state.level++;
    state.answerWord = state.ANSWER_POOL[randInt(state.ANSWER_POOL.length)];
    state.bank = buildBankFrom(state.answerWord);
    state.current = Array(5).fill('');
    state.locked = Array(5).fill(false);
    state.placedIndex = Array(5).fill(null);
    renderUI();
    startTimer();
  }

  function startRun(){
    state.lives = STARTING_LIVES;
    state.level = 1;
    state.runStartAt = Date.now();
    nextWord(false);
  }

  // ------------------------------
  // 9) Input handlers
  // ------------------------------
  function firstUnlockedSlot(){
    for(let i=0;i<5;i++) if(!state.locked[i] && !state.current[i]) return i;
    return -1;
  }

  function onLetterTap(bankIndex){
    if(state.inputsDisabled) return;
    const entry = state.bank[bankIndex];
    if(!entry || entry.used) return;
    const slot = firstUnlockedSlot();
    if(slot === -1) return;
    state.current[slot] = entry.ch;
    state.placedIndex[slot] = bankIndex;
    entry.used = true;
    renderAnswerRow(); // ensures letter becomes visible (removes .empty)

    const node = answerRow.children[slot];
    node.classList.remove('pop'); void node.offsetWidth; node.classList.add('pop');

    autoSubmitIfFull();
    renderBankRow();
  }

  function onShuffle(){
    // Shuffle only unused letters, preserving used positions
    const unusedIndices = state.bank.map((b,i)=> b.used ? null : i).filter(i=>i!==null);
    const unusedLetters = unusedIndices.map(i=> state.bank[i].ch);
    shuffleArray(unusedLetters);
    unusedIndices.forEach((idx,k)=>{ state.bank[idx].ch = unusedLetters[k]; });
    bankRow.classList.remove('jiggle'); void bankRow.offsetWidth; bankRow.classList.add('jiggle');
    renderBankRow();
  }

  function onClearAll(){
    for(let i=0;i<5;i++){
      if(state.locked[i]) continue;
      const bi = state.placedIndex[i];
      if(bi !== null){ state.bank[bi].used = false; }
      state.current[i] = '';
      state.placedIndex[i] = null;
    }
    renderUI();
  }

  function autoSubmitIfFull(){
    if(state.current.every(ch=>!!ch)){
      evaluateGuess(state.current.join(''));
    }
  }

  function evaluateGuess(guess){
    if(state.isAnimating) return;
    if(guess === state.answerWord){
      stopTimer();
      celebrateCorrect();
    } else if(state.ACCEPTED_SET.has(guess)){
      state.lives = Math.max(0, state.lives - 1);
      for(let i=0;i<5;i++){
        if(guess[i] === state.answerWord[i]){
          state.locked[i] = true;
        }else{
          const bi = state.placedIndex[i];
          if(bi !== null) state.bank[bi].used = false;
          state.current[i] = '';
          state.placedIndex[i] = null;
        }
      }
      renderUI();
      if(state.lives === 0){ gameOver(); }
    } else {
      answerRow.classList.remove('shake'); void answerRow.offsetWidth; answerRow.classList.add('shake');
      for(let i=0;i<5;i++){
        if(state.locked[i]) continue;
        const bi = state.placedIndex[i];
        if(bi !== null) state.bank[bi].used = false;
        state.current[i] = '';
        state.placedIndex[i] = null;
      }
      renderUI();
    }
  }

  function celebrateCorrect(){
    // Pop only the tiles that were just guessed (ignore previously locked tiles), then advance
    state.isAnimating = true;
    state.inputsDisabled = true;
    const tiles = [...answerRow.children];
    tiles.forEach((t, i) => {
      if (!state.locked[i]) {
        t.classList.remove('pop','popwin');
        void t.offsetWidth; // restart animation
        t.classList.add('popwin'); // exaggerated pop just for the win
      }
    });
    setTimeout(() => {
      state.isAnimating = false;
      state.inputsDisabled = false;
      nextWord(true);
    }, 360); // match .popwin duration + tiny buffer
  }

  function onTimeout(){
    state.lives = Math.max(0, state.lives - 1);
    state.inputsDisabled = true;
    for(let i=0;i<5;i++){
      state.current[i] = state.answerWord[i];
    }
    renderUI();
    answerRow.classList.remove('shudder'); void answerRow.offsetWidth; answerRow.classList.add('shudder');
    announce(`Time's up — the word was ${state.answerWord}.`);
    setTimeout(()=>{
      if(state.lives > 0){ nextWord(true); }
      else { gameOver(); }
      state.inputsDisabled = false;
    }, 800);
  }

  function gameOver(){
    stopTimer();
    const levelsCompleted = Math.max(0, state.level - 1);
    const secs = Math.round((Date.now() - state.runStartAt)/1000);
    const mm = String(Math.floor(secs/60)).padStart(2,'0');
    const ss = String(secs%60).padStart(2,'0');
    goBody.innerHTML = `You reached level ${levelsCompleted}${secs>0?('<br>Run time ' + mm + ':' + ss ):''}`;
    setBackdrop(gameoverBackdrop, true);
  }

  // ------------------------------
  // 10) Keyboard (desktop)
  // ------------------------------
  function handleKey(e){
    if(loadingBackdrop.classList.contains('show') || introBackdrop.classList.contains('show') || gameoverBackdrop.classList.contains('show') || state.inputsDisabled){ return; }
    const k = e.key;
    if(k === ' '){ e.preventDefault(); onShuffle(); return; }
    if(k === 'Backspace' || k === 'Delete'){ e.preventDefault(); onClearAll(); return; }
    const m = k.toUpperCase();
    if(m.length === 1 && m >= 'A' && m <= 'Z'){
      for(let i=0;i<state.bank.length;i++){
        const b = state.bank[i];
        if(!b.used && b.ch === m){ onLetterTap(i); break; }
      }
    }
  }
  window.addEventListener('keydown', handleKey);

  // ------------------------------
  // 11) Wire controls
  // ------------------------------
  btnShuffle.addEventListener('click', onShuffle);
  btnClear.addEventListener('click', onClearAll);
  btnPlay.addEventListener('click', ()=>{ setBackdrop(introBackdrop,false); startRun(); });
  btnAgain.addEventListener('click', ()=>{ setBackdrop(gameoverBackdrop,false); startRun(); });

  // ------------------------------
  // 12) Boot
  // ------------------------------
  initTheme();
  renderUI();
  loadWordLists();
  </script>
</body>
</html>
