<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>JUMBL</title>
  <style>
    /* ------------------------------------------------------
       0) Base / Theme / Resets — flat, monochrome, no shadows
       ------------------------------------------------------ */
    :root{
      color-scheme: light dark; /* keep system UI in sync */
      /* Light (default) */
      --bg:#FFFFFF; --fg:#000000; --muted:rgba(0,0,0,.60); --track:rgba(0,0,0,.12);
      --tile-bg:#FFFFFF; --tile-fg:#000000; --btn-bg:#FFFFFF; --btn-fg:#000000;
      --border:rgba(0,0,0,.15); --radius:12px;
      /* layout clamps */
      --maxw:600px; /* app max width */
      --gap:10px;   /* tile/bank gap */
    }
    html.dark{
      /* Dark */
      --bg:#000000; --fg:#FFFFFF; --muted:rgba(255,255,255,.70); --track:rgba(255,255,255,.15);
      --tile-bg:#000000; --tile-fg:#FFFFFF; --btn-bg:#000000; --btn-fg:#FFFFFF;
      --border:rgba(255,255,255,.20);
    }

    *, *::before, *::after{ box-sizing: border-box; }
    html, body{ height:100%; }
    body{ margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; background:var(--bg); color:var(--fg); -webkit-text-size-adjust:100%; }
    :focus{ outline: auto; }
    :focus:not(:focus-visible){ outline: none; }
    a, button{ -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    button{ font:inherit; color:inherit; background:var(--btn-bg); border:1px solid var(--border); border-radius: var(--radius); padding:.75rem 1rem; cursor:pointer; }
    button:disabled{ opacity:.35; cursor: default; }

    /* ------------------------------
       1) App shell & safe-area insets
       ------------------------------ */
    .app{
      width: min(var(--vw, 100vw), var(--maxw));
      height: 100dvh;
      margin: 0 auto;
      display:flex; flex-direction:column;
      padding: calc(env(safe-area-inset-top) + 16px) 16px calc(env(safe-area-inset-bottom) + 18px);
      overflow: hidden; /* no scroll bounce */
      overscroll-behavior: none;
      gap: 12px;
    }

    /* ------------------------------
       2) Header (3-col grid)
       ------------------------------ */
    .header{ display:grid; grid-template-columns: 1fr 1fr 1fr; align-items:center; }
    .title{ text-align:center; font-weight:700; letter-spacing:.12em; }
    .theme-wrap{ justify-self:end; }
    .icon{ width:22px; height:22px; display:block; }
    .icon svg{ width:100%; height:100%; display:block; }

    /* ------------------------------
       3) Lives, Score, Timer
       ------------------------------ */
    .lives{ display:flex; justify-content:center; gap:8px; }
    .pip{ width:16px; aspect-ratio:1/1; border:1px solid var(--border); border-radius:6px; background: transparent;    }
    .pip.off{ opacity:.32; }
    .lives .pip:not(.off){ background: var(--fg); }

    .score{ text-align:center; font-size:14px; color:var(--muted); }

    .timer-card{ border:1px solid var(--border); border-radius: var(--radius); padding:10px; }
    .timer-rail{ position:relative; height:14px; border-radius:9999px; background:var(--track); overflow:hidden; }
    .timer-fill{ position:absolute; inset:0; transform-origin:left center; transform: scaleX(1); background:var(--fg); transition: transform 100ms linear; }

    /* ------------------------------
       4) Squares: Answer row & Letter bank
       ------------------------------ */
    .row, .bank{ display:grid; grid-template-columns: repeat(5, 1fr); gap: var(--gap); }
    .tile, .btn-letter{
      aspect-ratio:1/1;
      min-inline-size:56px; /* touch target */
      border:1px solid var(--border); border-radius: var(--radius);
      background: var(--tile-bg); color:var(--tile-fg);
      display:grid; place-items:center; font-weight:700; font-size: clamp(18px, 7vw, 28px);
      user-select:none;
    }
    .tile{ background:var(--tile-bg); }
    .tile.empty{ color: var(--muted); }
    .btn-letter{ background:var(--btn-bg); }
    .btn-letter[aria-pressed="true"], .btn-letter.used{ opacity:.32; }

    /* ------------------------------
       5) Controls
       ------------------------------ */
    .controls{ display:flex; justify-content:center; gap:12px; }
    .press{ transform: scale(.96); transition: transform 120ms ease; }

    /* ------------------------------
       6) Spacer to aid tall screens
       ------------------------------ */
    .spacer{ flex:1 1 auto; }

    /* ------------------------------
       7) Animations (motion-only) & reduced-motion
       ------------------------------ */
    @keyframes shake{ 0%,100%{transform:translateX(0)} 20%{transform:translateX(-6px)} 40%{transform:translateX(6px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }
    @keyframes jiggle{ 0%,100%{ transform:rotate(0) } 25%{ transform:rotate(-2deg) } 75%{ transform:rotate(2deg) } }
    @keyframes shudder{ 0%,100%{transform:translateY(0)} 25%{transform:translateY(-3px)} 50%{transform:translateY(3px)} 75%{transform:translateY(-2px)} }
    @keyframes pop{ 0%{ transform:scale(1) } 50%{ transform:scale(1.06) } 100%{ transform:scale(1) } }

    .shake{ animation: shake .22s linear; }
    .jiggle{ animation: jiggle .26s ease-in-out; }
    .shudder{ animation: shudder .8s ease-in-out; }
    .pop{ animation: pop .6s ease; }

    @media (prefers-reduced-motion: reduce){
      .shake, .jiggle, .shudder, .pop{ animation-duration: .01s; }
      .timer-fill{ transition: none; }
    }

    /* ------------------------------
       8) Modals (Intro, Game Over, Loading/Retry)
       ------------------------------ */
    .overlay{ position:fixed; inset:0; background: rgba(0,0,0,.55); display:none; }
    .overlay[aria-hidden="false"]{ display:block; }
    .dialog{ position:fixed; inset:0; display:none; place-items:center; }
    .dialog[aria-hidden="false"]{ display:grid; pointer-events:auto; }
    .card{ width:min(92vw, 520px); background:var(--bg); color:var(--fg); border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow:none; }
    .card h2{ margin:0 0 10px; letter-spacing:.06em; }
    .card p{ margin:.5rem 0; color:var(--muted); }
    .card .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:16px; }

    /* ------------------------------
       9) Visually-hidden for a11y
       ------------------------------ */
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body>
  <div id="app" class="app" aria-live="polite">
    <!-- Header -->
    <header class="header">
      <div></div>
      <div class="title" aria-hidden="true">JUMBL</div>
      <div class="theme-wrap">
        <button id="themeBtn" class="icon" aria-label="Toggle theme" title="Toggle theme">
          <!-- default sun (monochrome, symmetric) -->
          <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="4"></circle>
            <g>
              <line x1="12" y1="1.5" x2="12" y2="4.5"></line>
              <line x1="12" y1="19.5" x2="12" y2="22.5"></line>
              <line x1="1.5" y1="12" x2="4.5" y2="12"></line>
              <line x1="19.5" y1="12" x2="22.5" y2="12"></line>
              <line x1="4.22" y1="4.22" x2="6.34" y2="6.34"></line>
              <line x1="17.66" y1="17.66" x2="19.78" y2="19.78"></line>
              <line x1="4.22" y1="19.78" x2="6.34" y2="17.66"></line>
              <line x1="17.66" y1="6.34" x2="19.78" y2="4.22"></line>
            </g>
          </svg>
        </button>
      </div>
    </header>

    <!-- Lives -->
    <div id="lives" class="lives" aria-label="Lives" aria-live="polite"></div>
    <!-- Score -->
    <div id="score" class="score" aria-live="polite">Score: 0</div>

    <!-- Timer -->
    <section class="timer-card">
      <div id="timerRail" class="timer-rail" role="progressbar" aria-label="Time remaining (seconds)" aria-valuemin="0" aria-valuemax="25" aria-valuenow="25">
        <div id="timerFill" class="timer-fill"></div>
      </div>
      <span id="srSeconds" class="sr-only" aria-live="polite"></span>
    </section>

    <!-- Answer row above Letter bank (strict) -->
    <section id="answerRow" class="row" aria-label="Your guess"></section>
    <section id="bank" class="bank" aria-label="Letter bank"></section>

    <!-- Controls -->
    <div class="controls">
      <button id="shuffleBtn" type="button" aria-label="Shuffle letters">Shuffle</button>
      <button id="clearBtn" type="button" aria-label="Clear all">Clear</button>
    </div>

    <div class="spacer" aria-hidden="true"></div>

    <!-- A11y announcer for granular updates (letters placed, etc.) -->
    <div id="announcer" class="sr-only" aria-live="polite"></div>
  </div>

  <!-- Overlay + Dialog (reused for all modals) -->
  <div id="overlay" class="overlay" aria-hidden="true"></div>
  <div id="dialog" class="dialog" aria-hidden="true" aria-modal="true" role="dialog" aria-labelledby="dialogTitle">
    <div class="card" role="document">
      <h2 id="dialogTitle"></h2>
      <div id="dialogBody"></div>
      <div class="actions" id="dialogActions"></div>
    </div>
  </div>

  <script>
  (()=>{
    "use strict";

    /* ------------------------------
       1) Constants / State
       ------------------------------ */
    const COUNTDOWN_SECONDS = 25;
    const STARTING_LIVES = 3;
    const TICK_MS = 100;

    let ANSWER_POOL = [];
    let GUESSES_SET = new Set();

    const state = {
      answerWord: "",
      bank: /** @type {{ch:string, used:boolean}[]} */([]),
      current: ["","","","",""],
      placedIndex: [null,null,null,null,null],
      lives: STARTING_LIVES,
      score: 0,
      runStartAt: 0,
      deadlineAt: 0,
      timerHandle: null,
      isAnimating: false,
      modalOpen: false,
    };

    /* ------------------------------
       2) DOM helpers
       ------------------------------ */
    const $ = (sel, root=document) => root.querySelector(sel);
    const app = $("#app");
    const livesEl = $("#lives");
    const scoreEl = $("#score");
    const timerRail = $("#timerRail");
    const timerFill = $("#timerFill");
    const srSeconds = $("#srSeconds");
    const answerRow = $("#answerRow");
    const bankRow = $("#bank");
    const announcer = $("#announcer");
    const shuffleBtn = $("#shuffleBtn");
    const clearBtn = $("#clearBtn");

    const overlay = $("#overlay");
    const dialog = $("#dialog");
    const dialogTitle = $("#dialogTitle");
    const dialogBody = $("#dialogBody");
    const dialogActions = $("#dialogActions");

    /* ------------------------------
       3) Viewport var --vw updates
       ------------------------------ */
    function setVW(){
      const w = (window.visualViewport ? visualViewport.width : window.innerWidth) || window.innerWidth;
      document.documentElement.style.setProperty('--vw', w + 'px');
    }
    setVW();
    if(window.visualViewport){
      visualViewport.addEventListener('resize', setVW);
      visualViewport.addEventListener('scroll', setVW);
    }
    window.addEventListener('orientationchange', setVW);
    window.addEventListener('resize', setVW);
    window.addEventListener('pageshow', setVW);

    /* ------------------------------
       4) Theme (persist localStorage)
       ------------------------------ */
    const THEME_KEY = 'jumbl-theme';
    function applyTheme(t){ document.documentElement.classList.toggle('dark', t === 'dark'); updateThemeIcon(); }
    function getSystemTheme(){ return matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'; }
    function initTheme(){ applyTheme(localStorage.getItem(THEME_KEY) || getSystemTheme()); }
    function toggleTheme(){ const isDark = document.documentElement.classList.toggle('dark'); localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light'); updateThemeIcon(); }
    function updateThemeIcon(){
      const isDark = document.documentElement.classList.contains('dark');
      const svg = $("#themeIcon");
      if(!svg) return;
      // swap between sun and moon (monochrome)
      if(isDark){
        svg.innerHTML = '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';
      }else{
        svg.innerHTML = '<circle cx="12" cy="12" r="4"></circle>'+
                         '<line x1="12" y1="1.5" x2="12" y2="4.5"></line>'+
                         '<line x1="12" y1="19.5" x2="12" y2="22.5"></line>'+
                         '<line x1="1.5" y1="12" x2="4.5" y2="12"></line>'+
                         '<line x1="19.5" y1="12" x2="22.5" y2="12"></line>'+
                         '<line x1="4.22" y1="4.22" x2="6.34" y2="6.34"></line>'+
                         '<line x1="17.66" y1="17.66" x2="19.78" y2="19.78"></line>'+
                         '<line x1="4.22" y1="19.78" x2="6.34" y2="17.66"></line>'+
                         '<line x1="17.66" y1="6.34" x2="19.78" y2="4.22"></line>';
      }
    }
    $("#themeBtn").addEventListener('click', toggleTheme);

    /* ------------------------------
       5) Utilities
       ------------------------------ */
    const randInt = n => Math.floor(Math.random()*n);
    function shuffleInPlace(arr){ for(let i=arr.length-1;i>0;i--){ const j = randInt(i+1); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
    function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

    function normalizeList(text){
      // strip BOM
      if(text.charCodeAt(0) === 0xFEFF){ text = text.slice(1); }
      const seen = new Set();
      const out = [];
      text.split(/\r\n?|\n/).forEach(line=>{
        const s = line.trim().toUpperCase();
        if(/^[A-Z]{5}$/.test(s) && !seen.has(s)){ seen.add(s); out.push(s); }
      });
      return out;
    }

    function pickAnswer(){
      return ANSWER_POOL[randInt(ANSWER_POOL.length)];
    }

    function buildBankFrom(word){
      const arr = word.split("").map(ch=>({ ch, used:false }));
      return shuffleInPlace(arr);
    }

    function secondsSince(ts){ return Math.floor((Date.now()-ts)/1000); }
    function fmtMMSS(total){ const m = Math.floor(total/60).toString().padStart(2,'0'); const s = (total%60).toString().padStart(2,'0'); return `${m}:${s}`; }

    /* ------------------------------
       6) Rendering
       ------------------------------ */
    function renderLives(){
      const frag = document.createDocumentFragment();
      for(let i=0;i<STARTING_LIVES;i++){
        const d = document.createElement('div');
        d.className = 'pip' + (i < state.lives ? '' : ' off');
        frag.appendChild(d);
      }
      livesEl.innerHTML = '';
      livesEl.appendChild(frag);
      livesEl.setAttribute('aria-label', `Lives: ${state.lives} of ${STARTING_LIVES}`);
    }

    function renderScore(){ scoreEl.textContent = `Score: ${state.score}`; }

    function renderTimer(){
      const now = performance.now();
      const remain = clamp(state.deadlineAt - now, 0, COUNTDOWN_SECONDS*1000);
      const ratio = remain / (COUNTDOWN_SECONDS*1000);
      timerFill.style.transform = `scaleX(${ratio})`; // right->left via transform-origin:left
      const secs = Math.round(remain/1000);
      timerRail.setAttribute('aria-valuenow', String(secs));
      // Speak at most once per second
      srSeconds.textContent = `${secs} seconds remaining`;
    }

    function renderAnswer(){
      const frag = document.createDocumentFragment();
      for(let i=0;i<5;i++){
        const v = state.current[i] || '';
        const d = document.createElement('div');
        d.className = 'tile' + (v ? '' : ' empty');
        d.textContent = v;
        d.setAttribute('aria-label', v ? `Slot ${i+1}: ${v}` : `Slot ${i+1}: empty`);
        frag.appendChild(d);
      }
      answerRow.innerHTML = '';
      answerRow.appendChild(frag);
    }

    function renderBank(){
      const frag = document.createDocumentFragment();
      state.bank.forEach((b, idx)=>{
        const btn = document.createElement('button');
        btn.className = 'btn-letter';
        btn.type = 'button';
        btn.textContent = b.ch;
        btn.disabled = b.used;
        btn.setAttribute('aria-pressed', b.used ? 'true' : 'false');
        btn.dataset.idx = String(idx);
        frag.appendChild(btn);
      });
      bankRow.innerHTML = '';
      bankRow.appendChild(frag);
    }

    function renderUI(){
      renderLives();
      renderScore();
      renderTimer();
      renderAnswer();
      renderBank();
    }

    /* ------------------------------
       7) Timer control
       ------------------------------ */
    function startTimer(){
      stopTimer();
      state.deadlineAt = performance.now() + COUNTDOWN_SECONDS*1000;
      renderTimer();
      state.timerHandle = setInterval(()=>{
        renderTimer();
        if(performance.now() >= state.deadlineAt){ onTimeout(); }
      }, TICK_MS);
    }
    function stopTimer(){ if(state.timerHandle){ clearInterval(state.timerHandle); state.timerHandle = null; } }

    /* ------------------------------
       8) Core game flow
       ------------------------------ */
    function startRun(){
      state.lives = STARTING_LIVES;
      state.score = 0;
      state.runStartAt = Date.now();
      nextWord(false);
    }

    function nextWord(increment){
      if(increment) state.score++;
      state.answerWord = pickAnswer();
      state.bank = buildBankFrom(state.answerWord);
      state.current = ["","","","",""];
      state.placedIndex = [null,null,null,null,null];
      state.isAnimating = false;
      renderUI();
      startTimer();
    }

    function onTimeout(){
      if(state.timerHandle === null) return; // already handled
      stopTimer();
      state.lives = Math.max(0, state.lives - 1);
      renderLives();
      // Reveal the correct word in answer row, shudder, then advance or game over
      state.isAnimating = true;
      for(let i=0;i<5;i++){ state.current[i] = state.answerWord[i]; }
      renderAnswer();
      answerRow.classList.remove('shudder','jiggle','pop');
      void answerRow.offsetWidth; // force reflow so the animation can restart
      answerRow.classList.add('shudder');

      setTimeout(()=>{
        answerRow.classList.remove('shudder');
        state.isAnimating = false;
        if(state.lives > 0){ nextWord(false); }
        else{ gameOver(); }
      }, 800);
    }

    function onLetterTap(bankIndex){
      if(state.isAnimating || state.modalOpen) return;
      const idx = state.placedIndex.indexOf(null); // next empty slot
      if(idx === -1) return; // full
      const b = state.bank[bankIndex];
      if(!b || b.used) return;
      b.used = true;
      state.current[idx] = b.ch;
      state.placedIndex[idx] = bankIndex;
      renderAnswer();
      renderBank();
      announcer.textContent = `Placed ${b.ch} in slot ${idx+1}`;
      // slot pop
      answerRow.classList.remove('pop');
      void answerRow.offsetWidth; // reflow to restart animation
      answerRow.classList.add('pop');
      autoSubmitIfFull();
    }

    function onShuffle(){
      if(state.isAnimating || state.modalOpen) return;
      // shuffle only unused letters
      const unused = [];
      const unusedIdx = [];
      state.bank.forEach((b, i)=>{ if(!b.used){ unused.push(b); unusedIdx.push(i); } });
      shuffleInPlace(unused);
      unusedIdx.forEach((slot, j)=>{ state.bank[slot] = unused[j]; });
      renderBank();
      bankRow.classList.remove('jiggle'); void bankRow.offsetWidth; bankRow.classList.add('jiggle');
    }

    function onClearAll(){
      if(state.isAnimating || state.modalOpen) return;
      for(let i=0;i<5;i++){
        const bi = state.placedIndex[i];
        if(bi !== null){ state.bank[bi].used = false; }
        state.current[i] = "";
        state.placedIndex[i] = null;
      }
      renderAnswer();
      renderBank();
      // shake to acknowledge clear
      answerRow.classList.remove('shake'); void answerRow.offsetWidth; answerRow.classList.add('shake');
    }

    function autoSubmitIfFull(){
      if(state.current.every(c=>c)){
        evaluateGuess(state.current.join(''));
      }
    }

    function evaluateGuess(guess){
      if(GUESSES_SET.has(guess)){
        // Correct (any real anagram in guesses.txt). Celebrate, advance, refill timer.
        stopTimer();
        state.isAnimating = true;
        answerRow.classList.remove('pop'); void answerRow.offsetWidth; answerRow.classList.add('pop');
        setTimeout(()=>{ state.isAnimating = false; nextWord(true); }, 600);
      }else{
        // Invalid: shake + clear; timer continues; no life loss.
        answerRow.classList.remove('shake'); void answerRow.offsetWidth; answerRow.classList.add('shake');
        setTimeout(onClearAll, 220);
      }
    }

    function gameOver(){
      stopTimer();
      showModal('GAME OVER',
        `<p><strong>${state.score}</strong> words in <strong>${fmtMMSS(secondsSince(state.runStartAt))}</strong></p>`,
        [ {label:'Again', action:()=>{ closeModal(); startRun(); }, isPrimary:true} ]
      );
    }

    /* ------------------------------
       9) Events — clicks & keyboard
       ------------------------------ */
    bankRow.addEventListener('click', (e)=>{
      const t = e.target;
      if(!(t instanceof HTMLElement)) return;
      if(t.classList.contains('btn-letter')){
        const idx = Number(t.dataset.idx);
        onLetterTap(idx);
      }
    });

    shuffleBtn.addEventListener('click', ()=>{ bounce(shuffleBtn); onShuffle(); });
    clearBtn.addEventListener('click', ()=>{ bounce(clearBtn); onClearAll(); });

    function bounce(btn){
      btn.classList.remove('press');
      void btn.offsetWidth; // restart
      btn.classList.add('press');
      setTimeout(()=>btn.classList.remove('press'), 140);
    }

    document.addEventListener('keydown', (e)=>{
      if(state.modalOpen || state.isAnimating) return;
      const k = e.key;
      if(k === ' '){ e.preventDefault(); onShuffle(); return; }
      if(k === 'Backspace' || k === 'Delete'){ e.preventDefault(); onClearAll(); return; }
      if(k.length === 1){
        const ch = k.toUpperCase();
        if(ch < 'A' || ch > 'Z') return;
        // find leftmost matching UNUSED bank letter
        const i = state.bank.findIndex(b => !b.used && b.ch === ch);
        if(i !== -1){ onLetterTap(i); }
      }
    }, true);

    /* ------------------------------
       10) Modals (reusable) + focus mgmt
       ------------------------------ */
    let restoreFocusEl = null;
    function showModal(title, bodyHTML, actions){
      state.modalOpen = true;
      overlay.setAttribute('aria-hidden','false');
      dialog.setAttribute('aria-hidden','false');
      dialogTitle.textContent = title;
      dialogBody.innerHTML = bodyHTML;
      dialogActions.innerHTML = '';
      actions.forEach(a=>{
        const b = document.createElement('button');
        b.type = 'button';
        b.textContent = a.label;
        if(a.isPrimary) b.autofocus = true;
        b.addEventListener('click', a.action);
        dialogActions.appendChild(b);
      });
      restoreFocusEl = document.activeElement;
      const firstBtn = dialogActions.querySelector('button') || dialog.querySelector('button');
      if(firstBtn) firstBtn.focus();
      // basic trap
      dialog.addEventListener('keydown', trapTab);
      document.addEventListener('keydown', escClose);
      app.setAttribute('aria-hidden','true');
    }
    function closeModal(){
      state.modalOpen = false;
      overlay.setAttribute('aria-hidden','true');
      dialog.setAttribute('aria-hidden','true');
      dialog.removeEventListener('keydown', trapTab);
      document.removeEventListener('keydown', escClose);
      app.removeAttribute('aria-hidden');
      if(restoreFocusEl && restoreFocusEl.focus) restoreFocusEl.focus();
    }
    function trapTab(e){
      if(e.key !== 'Tab') return;
      const focusables = dialog.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      if(!focusables.length) return;
      const first = focusables[0]; const last = focusables[focusables.length-1];
      if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    }
    function escClose(e){ if(e.key === 'Escape'){ closeModal(); } }

    function showLoading(msg, canRetry){
      const retryBtn = { label:'Retry', action:()=>{ closeModal(); loadWordLists(); }, isPrimary:true };
      showModal('Loading word lists…', `<p>${msg}</p>`, canRetry ? [retryBtn] : []);
    }

    function showIntro(){
      const body = `
        <p>Un-JUMBL the letters to make a 5-letter word.</p>
        <p>Beat the clock to increase your score and refill the timer.</p>
        <p>If the timer hits zero, you lose a life.</p>
        <p><strong>25 seconds</strong> per word • <strong>3 lives</strong></p>
        <p>Highest score wins.</p>`;
      showModal('RULES', body, [ {label:'Play', action:()=>{ closeModal(); startRun(); }, isPrimary:true} ]);
    }

    /* ------------------------------
       11) Data loading & validation
       ------------------------------ */
    async function loadWordLists(){
      showLoading('Fetching…', false);
      try{
        const ctrl = new AbortController();
        const opts = { cache: 'no-store', signal: ctrl.signal };
        const [aRes, gRes] = await Promise.all([
          fetch('answers.txt', opts),
          fetch('guesses.txt', opts)
        ]);
        if(!aRes.ok || !gRes.ok) throw new Error('Network error while fetching lists.');
        const [aText, gText] = await Promise.all([aRes.text(), gRes.text()]);
        const answers = normalizeList(aText);
        const guesses = normalizeList(gText);
        if(!answers.length || !guesses.length) throw new Error('One or both files are empty after parsing.');
        // Build sets and validate subset
        const gSet = new Set(guesses);
        const missing = answers.filter(w => !gSet.has(w));
        if(missing.length){
          showModal('Error in word lists', `<p>All answers must also appear in <code>guesses.txt</code>.</p><p>Missing ${missing.length} entries. Example: <code>${missing.slice(0,5).join(', ')}</code></p>`, [ {label:'Retry', action:()=>{ closeModal(); loadWordLists(); }, isPrimary:true} ]);
          return;
        }
        ANSWER_POOL = answers;
        GUESSES_SET = gSet;
        closeModal();
        // After lists load, show Intro
        showIntro();
      }catch(err){
        console.error(err);
        showLoading('Error loading word lists. Please try again.', true);
      }
    }

    /* ------------------------------
       12) Boot
       ------------------------------ */
    initTheme();
    loadWordLists();

  })();
  </script>
</body>
</html>